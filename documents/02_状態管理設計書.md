# çŠ¶æ…‹ç®¡ç†è¨­è¨ˆæ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0  
**ä½œæˆæ—¥**: 2025å¹´11æœˆ12æ—¥  
**æ›´æ–°æ—¥**: 2025å¹´11æœˆ13æ—¥  
**å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: ãƒãƒ¼ãƒ‰ãƒœã‚¤ãƒ«ãƒ‰åˆ‘äº‹é¢¨ã‚²ãƒ¼ãƒ 

---

## ğŸ“‹ ç›®æ¬¡

1. [çŠ¶æ…‹ç®¡ç†ã®å…¨ä½“æ–¹é‡](#çŠ¶æ…‹ç®¡ç†ã®å…¨ä½“æ–¹é‡)
2. [ã‚¹ãƒˆã‚¢æ§‹æˆ](#ã‚¹ãƒˆã‚¢æ§‹æˆ)
3. [gameStoreï¼ˆã‚²ãƒ¼ãƒ å…¨ä½“ç®¡ç†ï¼‰](#gamestoreã‚²ãƒ¼ãƒ å…¨ä½“ç®¡ç†)
4. [playerStoreï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼‰](#playerstoreãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†)
5. [battleStoreï¼ˆæˆ¦é—˜ç®¡ç†ï¼‰](#battlestoreæˆ¦é—˜ç®¡ç†)
6. [çŠ¶æ…‹é·ç§»å›³](#çŠ¶æ…‹é·ç§»å›³)
7. [ã‚¹ãƒˆã‚¢é–“ã®é€£æº](#ã‚¹ãƒˆã‚¢é–“ã®é€£æº)

---

## çŠ¶æ…‹ç®¡ç†ã®å…¨ä½“æ–¹é‡

### æ¡ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **Zustand**: è»½é‡ã§ã‚·ãƒ³ãƒ—ãƒ«ãªçŠ¶æ…‹ç®¡ç†
- React Context APIã¯ä½¿ç”¨ã—ãªã„ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ï¼‰

### è¨­è¨ˆåŸå‰‡

1. **è²¬å‹™ã®åˆ†é›¢**
   - å„ã‚¹ãƒˆã‚¢ã¯æ˜ç¢ºãªè²¬å‹™ã‚’æŒã¤
   - ã‚¹ãƒˆã‚¢é–“ã®ä¾å­˜ã¯æœ€å°é™ã«

2. **ä¸å¤‰æ€§ã®ä¿æŒ**
   - çŠ¶æ…‹æ›´æ–°ã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã«
   - spreadæ¼”ç®—å­ã‚„immerã‚’æ´»ç”¨

3. **æ°¸ç¶šåŒ–**
   - playerStoreã¨gameStoreã®ä¸€éƒ¨ã‚’localStorageã«ä¿å­˜
   - battleStoreã¯æˆ¦é—˜ä¸­ã®ã¿æœ‰åŠ¹ï¼ˆæ°¸ç¶šåŒ–ä¸è¦ï¼‰

4. **TypeScriptå®Œå…¨å¯¾å¿œ**
   - ã™ã¹ã¦ã®ã‚¹ãƒˆã‚¢ã«å‹å®šç¾©
   - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å¼•æ•°ãƒ»æˆ»ã‚Šå€¤ã‚‚å‹å®‰å…¨ã«

---

## ã‚¹ãƒˆã‚¢æ§‹æˆ

### å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Application                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ gameStore  â”‚  â”‚playerStore â”‚            â”‚
â”‚  â”‚            â”‚  â”‚            â”‚            â”‚
â”‚  â”‚ - screen   â”‚  â”‚ - stats    â”‚            â”‚
â”‚  â”‚ - progress â”‚  â”‚ - money    â”‚            â”‚
â”‚  â”‚            â”‚  â”‚ - units    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚              â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                â”‚                             â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚battleStore  â”‚                     â”‚
â”‚         â”‚             â”‚                     â”‚
â”‚         â”‚ - field     â”‚                     â”‚
â”‚         â”‚ - turn      â”‚                     â”‚
â”‚         â”‚ - attack    â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¹ãƒˆã‚¢åˆ¥è²¬å‹™

| ã‚¹ãƒˆã‚¢ | è²¬å‹™ | æ°¸ç¶šåŒ– |
|--------|------|--------|
| gameStore | ç”»é¢é·ç§»ã€ã‚²ãƒ¼ãƒ é€²è¡ŒçŠ¶æ³ | â—‹ï¼ˆprogresséƒ¨åˆ†ï¼‰ |
| playerStore | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€æ‰€æŒé‡‘ã€æ‰€æŒéƒ¨éšŠ | â—‹ï¼ˆå…¨ä½“ï¼‰ |
| battleStore | æˆ¦é—˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€ã‚¿ãƒ¼ãƒ³åˆ¶å¾¡ã€æ”»æ’ƒå‡¦ç† | Ã— |

---

## gameStoreï¼ˆã‚²ãƒ¼ãƒ å…¨ä½“ç®¡ç†ï¼‰

### è²¬å‹™
- ç”»é¢é·ç§»ã®ç®¡ç†
- ç¾åœ¨é¸æŠä¸­ã®æ•µã®ç®¡ç†
- ã‚²ãƒ¼ãƒ é€²è¡ŒçŠ¶æ³ã®ç®¡ç†
- ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰å‡¦ç†

### Stateï¼ˆçŠ¶æ…‹ï¼‰

```typescript
interface GameState {
  // ç”»é¢ç®¡ç†
  currentScreen: GameScreen
  
  // ã‚²ãƒ¼ãƒ é€²è¡ŒçŠ¶æ³
  progress: GameProgress
  
  // ç¾åœ¨é¸æŠä¸­ã®æ•µ
  selectedEnemy: EnemyId | null
  
  // ãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹
  isLoading: boolean
  
  // åˆå›èµ·å‹•ã‹ã©ã†ã‹
  isFirstLaunch: boolean
}

enum GameScreen {
  TITLE = 'title',                    // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢
  CHARACTER_SELECT = 'character_select', // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ
  ENEMY_SELECT = 'enemy_select',      // æ•µé¸æŠ
  SHOP = 'shop',                      // ã‚·ãƒ§ãƒƒãƒ—
  LEVELUP = 'levelup',                // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
  PLACEMENT = 'placement',            // éƒ¨éšŠé…ç½®
  BATTLE = 'battle',                  // æˆ¦é—˜
  RESULT = 'result',                  // æˆ¦é—˜çµæœ
  MENU = 'menu'                       // ãƒ¡ãƒ‹ãƒ¥ãƒ¼
}
```

### Actionsï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

```typescript
interface GameActions {
  // ç”»é¢é·ç§»
  navigateTo: (screen: GameScreen) => void
  
  // æ•µé¸æŠ
  selectEnemy: (enemyId: EnemyId) => void
  clearSelectedEnemy: () => void
  
  // é€²è¡ŒçŠ¶æ³æ›´æ–°
  markEnemyAsDefeated: (enemyId: EnemyId) => void
  incrementBattleCount: (isVictory: boolean) => void
  
  // ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰
  saveGame: () => Promise<void>
  loadGame: () => Promise<boolean>  // æˆåŠŸã—ãŸã‚‰true
  resetGame: () => void
  
  // åˆæœŸåŒ–
  initializeGame: () => Promise<void>
}
```

### ç”»é¢é·ç§»ãƒ•ãƒ­ãƒ¼

```
TITLE
  â†“ (æ–°è¦ã‚²ãƒ¼ãƒ )
CHARACTER_SELECT
  â†“ (ã‚­ãƒ£ãƒ©é¸æŠå®Œäº†)
ENEMY_SELECT â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â†“ (æ•µé¸æŠ)           â”‚
SHOP (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)       â”‚
  â†“                    â”‚
LEVELUP (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)    â”‚
  â†“                    â”‚
PLACEMENT              â”‚
  â†“ (é…ç½®å®Œäº†)         â”‚
BATTLE                 â”‚
  â†“ (æˆ¦é—˜çµ‚äº†)         â”‚
RESULT                 â”‚
  â†“ (æ¬¡ã®æ•µã¸) â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ (å…¨æ•µæ’ƒç ´)
ENDING
```

### å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

```typescript
export const useGameStore = create<GameState & GameActions>((set, get) => ({
  // State
  currentScreen: GameScreen.TITLE,
  progress: {
    defeatedEnemies: [],
    currentEnemy: null,
    totalBattles: 0,
    totalVictories: 0,
    totalDefeats: 0
  },
  selectedEnemy: null,
  isLoading: false,
  isFirstLaunch: true,
  
  // Actions
  navigateTo: (screen) => set({ currentScreen: screen }),
  
  selectEnemy: (enemyId) => set({ 
    selectedEnemy: enemyId,
    progress: { ...get().progress, currentEnemy: enemyId }
  }),
  
  clearSelectedEnemy: () => set({ 
    selectedEnemy: null,
    progress: { ...get().progress, currentEnemy: null }
  }),
  
  markEnemyAsDefeated: (enemyId) => set((state) => ({
    progress: {
      ...state.progress,
      defeatedEnemies: [...state.progress.defeatedEnemies, enemyId]
    }
  })),
  
  incrementBattleCount: (isVictory) => set((state) => ({
    progress: {
      ...state.progress,
      totalBattles: state.progress.totalBattles + 1,
      totalVictories: isVictory ? state.progress.totalVictories + 1 : state.progress.totalVictories,
      totalDefeats: !isVictory ? state.progress.totalDefeats + 1 : state.progress.totalDefeats
    }
  })),
  
  saveGame: async () => {
    // localStorageä¿å­˜å‡¦ç†
    // playerStoreã¨gameStoreã®progressã‚’ä¿å­˜
  },
  
  loadGame: async () => {
    // localStorageèª­ã¿è¾¼ã¿å‡¦ç†
    // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°trueã€ãªã‘ã‚Œã°false
  },
  
  resetGame: () => {
    // ã‚²ãƒ¼ãƒ ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
    // playerStoreã‚‚ãƒªã‚»ãƒƒãƒˆ
  },
  
  initializeGame: async () => {
    set({ isLoading: true })
    const hasData = await get().loadGame()
    set({ 
      isLoading: false,
      isFirstLaunch: !hasData
    })
  }
}))
```

---

## playerStoreï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼‰

### è²¬å‹™
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç®¡ç†
- æ‰€æŒé‡‘ãƒ»çµŒé¨“å€¤ã®ç®¡ç†
- æ‰€æŒéƒ¨éšŠã®ç®¡ç†
- ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†
- HPå›å¾©å‡¦ç†

### Stateï¼ˆçŠ¶æ…‹ï¼‰

```typescript
interface PlayerState {
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
  character: CharacterType | null
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  stats: PlayerStats
  maxStats: PlayerMaxStats
  levels: PlayerLevel
  
  // çµŒæ¸ˆ
  money: number
  exp: number
  
  // éƒ¨éšŠ
  ownedUnits: string[]  // æ‰€æŒéƒ¨éšŠIDã®é…åˆ—
  
  // é…ç½®ä¸­ã®éƒ¨éšŠï¼ˆæˆ¦é—˜æº–å‚™ãƒ»æˆ¦é—˜ä¸­ã®ã¿ä½¿ç”¨ï¼‰
  placedUnits: PlacedUnit[]
}
```

### Actionsï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

```typescript
interface PlayerActions {
  // åˆæœŸåŒ–
  selectCharacter: (character: CharacterType) => void
  resetPlayer: () => void
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†
  updateStats: (stats: Partial<PlayerStats>) => void
  restoreStats: () => void  // maxStatsã«æˆ»ã™
  
  // ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ»å›å¾©
  takeDamage: (amount: number) => void
  canHeal: () => boolean  // å›å¾©å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
  heal: () => { success: boolean; healAmount: number; spCost: number; reason?: string }  // å›å¾©å®Ÿè¡Œ
  consumeSP: (amount: number) => boolean  // æˆåŠŸã—ãŸã‚‰true
  
  // çµŒæ¸ˆ
  addMoney: (amount: number) => void
  spendMoney: (amount: number) => boolean  // æˆåŠŸã—ãŸã‚‰true
  addExp: (amount: number) => void
  
  // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
  canLevelUp: (stat: StatType) => boolean
  getLevelUpCost: (stat: StatType) => number
  levelUp: (stat: StatType) => boolean  // æˆåŠŸã—ãŸã‚‰true
  
  // éƒ¨éšŠç®¡ç†
  buyUnit: (unitId: string) => boolean  // æˆåŠŸã—ãŸã‚‰true
  hasUnit: (unitId: string) => boolean
  getUnitCount: (unitId: string) => number  // æ‰€æŒæ•°ã‚’è¿”ã™
  
  // éƒ¨éšŠé…ç½®ï¼ˆæˆ¦é—˜æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºï¼‰
  placeUnit: (unit: PlacedUnit) => boolean  // æˆåŠŸã—ãŸã‚‰true
  removeUnit: (unitId: string) => void
  clearPlacedUnits: () => void
  canPlaceUnit: (unitId: string) => boolean
  
  // ã‚»ãƒ¼ãƒ–ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—
  getPlayerData: () => SaveData['player']
  loadPlayerData: (data: SaveData['player']) => void
}
```

### ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚³ã‚¹ãƒˆè¨ˆç®—

```typescript
// requirements.mdã‚ˆã‚Š
function getLevelUpCost(stat: StatType, currentLevel: number): number {
  const baseCost = {
    HP: 50,
    SP: 30,
    AT: 40,
    DF: 35,
    AR: 60
  }
  
  return Math.floor(baseCost[stat] * Math.pow(1.3, currentLevel))
}
```

### å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

```typescript
export const usePlayerStore = create<PlayerState & PlayerActions>((set, get) => ({
  // State
  character: null,
  stats: { HP: 100, maxHP: 100, SP: 50, maxSP: 50, AT: 10, DF: 5, AR: 1 },
  maxStats: { maxHP: 100, maxSP: 50, maxAR: 11 },
  levels: { HP: 1, SP: 1, AT: 1, DF: 1, AR: 1 },
  money: 0,
  exp: 0,
  ownedUnits: [],
  placedUnits: [],
  
  // Actions
  selectCharacter: (character) => set({ character }),
  
  resetPlayer: () => set({
    character: null,
    stats: { HP: 100, maxHP: 100, SP: 50, maxSP: 50, AT: 10, DF: 5, AR: 1 },
    maxStats: { maxHP: 100, maxSP: 50, maxAR: 11 },
    levels: { HP: 1, SP: 1, AT: 1, DF: 1, AR: 1 },
    money: 0,
    exp: 0,
    ownedUnits: [],
    placedUnits: []
  }),
  
  updateStats: (newStats) => set((state) => ({
    stats: { ...state.stats, ...newStats }
  })),
  
  restoreStats: () => set((state) => ({
    stats: {
      HP: state.maxStats.maxHP,
      maxHP: state.maxStats.maxHP,
      SP: state.maxStats.maxSP,
      maxSP: state.maxStats.maxSP,
      AT: state.stats.AT,
      DF: state.stats.DF,
      AR: state.stats.AR
    }
  })),
  
  takeDamage: (amount) => set((state) => ({
    stats: { 
      ...state.stats, 
      HP: Math.max(0, state.stats.HP - amount) 
    }
  })),
  
  canHeal: () => {
    const state = get()
    const maxHealAmount = Math.floor(state.stats.maxHP * 0.3)
    const missingHP = state.stats.maxHP - state.stats.HP
    
    // æœ€ä½å›å¾©é‡ã‚’æº€ãŸã›ã‚‹ã‹ && SPãŒè¶³ã‚Šã‚‹ã‹
    return missingHP >= maxHealAmount && state.stats.SP >= maxHealAmount
  },
  
  heal: () => {
    const state = get()
    
    // å›å¾©é‡ã‚’è¨ˆç®—ï¼ˆæœ€å¤§HPã®30%ï¼‰
    const maxHealAmount = Math.floor(state.stats.maxHP * 0.3)
    const missingHP = state.stats.maxHP - state.stats.HP
    const actualHealAmount = Math.min(maxHealAmount, missingHP)
    
    // å›å¾©å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯
    if (actualHealAmount < maxHealAmount) {
      return {
        success: false,
        healAmount: 0,
        spCost: 0,
        reason: `æœ€ä½${maxHealAmount}HPå›å¾©ã§ãã¾ã›ã‚“`
      }
    }
    
    // SPæ¶ˆè²»é‡ï¼ˆ1HP = 1SPï¼‰
    const spCost = actualHealAmount
    
    if (state.stats.SP < spCost) {
      return {
        success: false,
        healAmount: 0,
        spCost: 0,
        reason: 'SPãŒä¸è¶³ã—ã¦ã„ã¾ã™'
      }
    }
    
    // å›å¾©ã‚’å®Ÿè¡Œ
    set((state) => ({
      stats: {
        ...state.stats,
        HP: Math.min(state.stats.maxHP, state.stats.HP + actualHealAmount),
        SP: state.stats.SP - spCost
      }
    }))
    
    return {
      success: true,
      healAmount: actualHealAmount,
      spCost
    }
  },
  
  consumeSP: (amount) => {
    const state = get()
    if (state.stats.SP < amount) return false
    
    set((state) => ({
      stats: { ...state.stats, SP: state.stats.SP - amount }
    }))
    return true
  },
  
  addMoney: (amount) => set((state) => ({
    money: state.money + amount
  })),
  
  spendMoney: (amount) => {
    const state = get()
    if (state.money < amount) return false
    
    set({ money: state.money - amount })
    return true
  },
  
  addExp: (amount) => set((state) => ({
    exp: state.exp + amount
  })),
  
  canLevelUp: (stat) => {
    const state = get()
    const cost = get().getLevelUpCost(stat)
    return state.money >= cost
  },
  
  getLevelUpCost: (stat) => {
    const state = get()
    return getLevelUpCost(stat, state.levels[stat])
  },
  
  levelUp: (stat) => {
    const state = get()
    const cost = get().getLevelUpCost(stat)
    
    if (!get().spendMoney(cost)) return false
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸Šæ˜‡é‡
    const increases = {
      HP: 20,
      SP: 10,
      AT: 5,
      DF: 3,
      AR: 1
    }
    
    const increase = increases[stat]
    
    set((state) => {
      const newStats = { ...state.stats }
      const newMaxStats = { ...state.maxStats }
      
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸Šæ˜‡
      newStats[stat] = state.stats[stat] + increase
      
      // HP/SPã®å ´åˆã¯æœ€å¤§å€¤ã‚‚æ›´æ–°
      if (stat === 'HP') {
        newStats.maxHP = state.stats.maxHP + increase
        newMaxStats.maxHP = state.maxStats.maxHP + increase
      } else if (stat === 'SP') {
        newStats.maxSP = state.stats.maxSP + increase
        newMaxStats.maxSP = state.maxStats.maxSP + increase
      }
      
      return {
        levels: { ...state.levels, [stat]: state.levels[stat] + 1 },
        stats: newStats,
        maxStats: newMaxStats
      }
    })
    
    return true
  },
  
  buyUnit: (unitId) => {
    // ãƒ¦ãƒ‹ãƒƒãƒˆè³¼å…¥å‡¦ç†
    // UNITSå®šæ•°ã‹ã‚‰priceã‚’å–å¾—ã—ã¦è³¼å…¥åˆ¤å®š
  },
  
  hasUnit: (unitId) => {
    return get().ownedUnits.includes(unitId)
  },
  
  getUnitCount: (unitId) => {
    return get().ownedUnits.filter(id => id === unitId).length
  },
  
  placeUnit: (unit) => {
    // é…ç½®å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    // - åŒã˜éƒ¨éšŠãŒæ—¢ã«é…ç½®ã•ã‚Œã¦ã„ãªã„ã‹ï¼ˆåœ°é›·ä»¥å¤–ï¼‰
    // - é…ç½®ä½ç½®ãŒæœ‰åŠ¹ã‹
    // - ã‚°ãƒªãƒƒãƒ‰å†…ã«åã¾ã‚‹ã‹
  },
  
  removeUnit: (unitId) => {
    set((state) => ({
      placedUnits: state.placedUnits.filter(u => u.unitId !== unitId)
    }))
  },
  
  clearPlacedUnits: () => set({ placedUnits: [] }),
  
  canPlaceUnit: (unitId) => {
    // é…ç½®å¯èƒ½åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
  },
  
  getPlayerData: () => {
    const state = get()
    return {
      character: state.character!,
      stats: state.stats,
      maxStats: state.maxStats,
      levels: state.levels,
      money: state.money,
      exp: state.exp,
      ownedUnits: state.ownedUnits
    }
  },
  
  loadPlayerData: (data) => {
    set({
      character: data.character,
      stats: data.stats,
      maxStats: data.maxStats,
      levels: data.levels,
      money: data.money,
      exp: data.exp,
      ownedUnits: data.ownedUnits
    })
  }
}))
```

---

## battleStoreï¼ˆæˆ¦é—˜ç®¡ç†ï¼‰

### è²¬å‹™
- æˆ¦é—˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç®¡ç†
- ã‚¿ãƒ¼ãƒ³åˆ¶å¾¡
- æ”»æ’ƒå‡¦ç†
- HIT/MISSåˆ¤å®š
- éƒ¨éšŠç ´å£Šåˆ¤å®š
- å‹æ•—åˆ¤å®š
- ç‰¹æ®Šæ”»æ’ƒã®å®Ÿè¡Œ

### Stateï¼ˆçŠ¶æ…‹ï¼‰

```typescript
interface BattleState {
  // æˆ¦é—˜ãƒ•ã‚§ãƒ¼ã‚º
  phase: BattlePhase
  turn: Turn
  
  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  playerField: Field
  enemyField: Field
  
  // æˆ¦é—˜ä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  playerStats: PlayerStats
  enemyStats: EnemyStats
  
  // å¯¾æˆ¦ç›¸æ‰‹
  enemy: Enemy
  
  // æ”»æ’ƒå±¥æ­´
  attackHistory: AttackLog[]
  
  // é€£ç¶šæ”»æ’ƒåˆ¶å¾¡
  canContinueAttack: boolean
  consecutiveHits: number
  
  // ç‰¹æ®Šæ”»æ’ƒçŠ¶æ…‹
  activeSpecialAttack: {
    type: SpecialAttackType | null
    startTime?: number
    endTime?: number
    remainingAttacks?: number
  }
  
  // ç‰¹æ®Šæ”»æ’ƒä½¿ç”¨å›æ•°ï¼ˆã‚¬ãƒ—ãƒªãƒ¼ãƒå°‚ç”¨ï¼‰
  specialAttackUsageCount: {
    player: { [unitId: string]: number }
    enemy: { [unitId: string]: number }
  }
  
  // æˆ¦é—˜çµæœï¼ˆçµæœãƒ•ã‚§ãƒ¼ã‚ºã§ä½¿ç”¨ï¼‰
  battleResult: BattleResult | null
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡
  isAnimating: boolean
  currentAnimation: {
    type: 'hit' | 'miss' | 'destroy' | 'special' | null
    position?: Position
  }
}
```

### Actionsï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

```typescript
interface BattleActions {
  // æˆ¦é—˜åˆæœŸåŒ–
  initializeBattle: (enemy: Enemy, playerUnits: PlacedUnit[]) => void
  resetBattle: () => void
  
  // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¶å¾¡
  setPhase: (phase: BattlePhase) => void
  switchTurn: () => void
  
  // æ”»æ’ƒå‡¦ç†
  attack: (position: Position) => AttackResult
  executeSpecialAttack: (unitId: string, position: Position) => AttackResult
  
  // HIT/MISSåˆ¤å®š
  checkHit: (position: Position, field: Field) => boolean
  processHit: (position: Position) => void
  processMiss: (position: Position) => void
  
  // éƒ¨éšŠç ´å£Š
  checkUnitDestroyed: (unitId: string) => boolean
  destroyUnit: (unitId: string) => void
  
  // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†
  calculateDamage: (attacker: 'player' | 'enemy') => number
  applyDamage: (target: 'player' | 'enemy', damage: number) => void
  
  // åœ°é›·å‡¦ç†
  triggerCounterAttack: (target: 'player' | 'enemy') => void
  
  // å‹æ•—åˆ¤å®š
  checkVictory: () => 'player' | 'enemy' | null
  endBattle: (winner: 'player' | 'enemy') => void
  
  // ç‰¹æ®Šæ”»æ’ƒ
  canUseSpecialAttack: (unitId: string) => boolean
  getSpecialAttackCost: (unitId: string) => number
  activateSpecialAttack: (type: SpecialAttackType) => void
  deactivateSpecialAttack: () => void
  
  // AIå‡¦ç†
  executeEnemyTurn: () => Promise<void>
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  setAnimation: (type: 'hit' | 'miss' | 'destroy' | 'special', position?: Position) => void
  clearAnimation: () => void
  
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  getCellState: (position: Position, field: Field) => CellState
  getPlacedUnit: (position: Position, field: Field) => PlacedUnit | null
  isValidPosition: (position: Position) => boolean
}

interface AttackResult {
  success: boolean
  isHit: boolean
  damage?: number
  destroyedUnitId?: string
  canContinue: boolean
}
```

### æ”»æ’ƒå‡¦ç†ãƒ•ãƒ­ãƒ¼

```
attack(position) é–‹å§‹
  â†“
æœ‰åŠ¹ãªä½ç½®ã‹ç¢ºèª
  â†“ NO â†’ ã‚¨ãƒ©ãƒ¼
  â†“ YES
HITåˆ¤å®š
  â†“
  â”œâ”€ HIT
  â”‚   â†“
  â”‚ éƒ¨éšŠãƒãƒ¼ã‚­ãƒ³ã‚°
  â”‚   â†“
  â”‚ éƒ¨éšŠç ´å£Šåˆ¤å®š
  â”‚   â†“ ç ´å£Šå®Œäº†
  â”‚   â”‚ â†’ çµŒé¨“å€¤ä»˜ä¸
  â”‚   â”‚ â†’ éƒ¨éšŠã‚²ãƒ¼ã‚¸æ¸›å°‘
  â”‚   â†“
  â”‚ åœ°é›·åˆ¤å®š
  â”‚   â†“ åœ°é›·ã ã£ãŸ
  â”‚   â”‚ â†’ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç™ºå‹•
  â”‚   â”‚ â†’ ã‚¿ãƒ¼ãƒ³äº¤ä»£
  â”‚   â†“
  â”‚ é€£ç¶šæ”»æ’ƒæ¨©ä»˜ä¸
  â”‚   â†“
  â”‚ return { isHit: true, canContinue: true }
  â”‚
  â””â”€ MISS
      â†“
    ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
      â†“
    ãƒ€ãƒ¡ãƒ¼ã‚¸é©ç”¨ï¼ˆç›¸æ‰‹HPæ¸›å°‘ï¼‰
      â†“
    ã‚¿ãƒ¼ãƒ³äº¤ä»£
      â†“
    return { isHit: false, canContinue: false }
```

### å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆä¸»è¦éƒ¨åˆ†ï¼‰

```typescript
export const useBattleStore = create<BattleState & BattleActions>((set, get) => ({
  // StateåˆæœŸå€¤
  phase: BattlePhase.PLACEMENT,
  turn: Turn.PLAYER,
  playerField: createEmptyField(7, 7),
  enemyField: createEmptyField(7, 7),
  // ... ä»–ã®åˆæœŸå€¤
  
  // Actions
  initializeBattle: (enemy, playerUnits) => {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ARãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚µã‚¤ã‚ºæ±ºå®š
    // æ•µã®ARãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚µã‚¤ã‚ºæ±ºå®š
    // æ•µã®éƒ¨éšŠã‚’ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ï¼ˆAIï¼‰
    // å…ˆåˆ¶æ”»æ’ƒåˆ¤å®š
  },
  
  attack: (position) => {
    const state = get()
    
    // 1. æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯
    if (!get().isValidPosition(position)) {
      return { success: false, isHit: false, canContinue: false }
    }
    
    // 2. ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é¸æŠ
    const targetField = state.turn === Turn.PLAYER ? state.enemyField : state.playerField
    
    // 3. HITåˆ¤å®š
    const isHit = get().checkHit(position, targetField)
    
    if (isHit) {
      // 4a. HITå‡¦ç†
      get().processHit(position)
      
      // 5a. éƒ¨éšŠç ´å£Šåˆ¤å®š
      const unit = get().getPlacedUnit(position, targetField)
      if (unit && get().checkUnitDestroyed(unit.unitId)) {
        get().destroyUnit(unit.unitId)
        
        // 6a. åœ°é›·åˆ¤å®š
        if (unit.unitId === 'mine') {
          get().triggerCounterAttack(state.turn === Turn.PLAYER ? 'player' : 'enemy')
          return { success: true, isHit: true, canContinue: false }
        }
      }
      
      return { success: true, isHit: true, canContinue: true }
    } else {
      // 4b. MISSå‡¦ç†
      get().processMiss(position)
      
      // 5b. ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ãƒ»é©ç”¨
      const damage = get().calculateDamage(state.turn === Turn.PLAYER ? 'player' : 'enemy')
      get().applyDamage(state.turn === Turn.PLAYER ? 'enemy' : 'player', damage)
      
      // 6b. ã‚¿ãƒ¼ãƒ³äº¤ä»£
      get().switchTurn()
      
      return { success: true, isHit: false, canContinue: false }
    }
  },
  
  checkHit: (position, field) => {
    const cell = field.cells[position.y][position.x]
    return cell.unitId !== undefined && cell.state === CellState.UNEXPLORED
  },
  
  calculateDamage: (attacker) => {
    // requirements.mdã®ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—å¼ã‚’å®Ÿè£…
    // baseDamage = AT Ã— (1 + random(-0.1, 0.1))
    // æ”»æ’ƒåŠ›è£œæ­£ï¼ˆçŸ³æ²¹ã‚¿ãƒ³ã‚«ãƒ¼ã€M4æˆ¦è»Šã€å·¨å¤§é£›è¡Œè‰‡ï¼‰ã‚’è¨ˆç®—
    // é˜²å¾¡åŠ›è£œæ­£ï¼ˆæ¶ˆé˜²è»Šã€ãƒ€ãƒ³ãƒ—ã€å·¨å¤§é£›è¡Œè‰‡ï¼‰ã‚’è¨ˆç®—
    // finalDamage = Math.max(1, baseDamage - totalDF)
  },
  
  checkVictory: () => {
    const state = get()
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‹åˆ©æ¡ä»¶
    if (state.enemyStats.HP <= 0 || state.enemyField.placedUnits.every(u => u.isDestroyed)) {
      return 'player'
    }
    
    // æ•µå‹åˆ©æ¡ä»¶
    if (state.playerStats.HP <= 0 || state.playerField.placedUnits.every(u => u.isDestroyed)) {
      return 'enemy'
    }
    
    return null
  },
  
  executeEnemyTurn: async () => {
    // AIã‚¨ãƒ³ã‚¸ãƒ³ã‚’å‘¼ã³å‡ºã—ã¦æ¬¡ã®æ‰‹ã‚’æ±ºå®š
    // await sleep()ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾…æ©Ÿ
    // æ”»æ’ƒå®Ÿè¡Œ
    // å‹æ•—åˆ¤å®š
  }
}))
```

---

## çŠ¶æ…‹é·ç§»å›³

### å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
[ã‚²ãƒ¼ãƒ èµ·å‹•]
     â†“
gameStore.initializeGame()
     â†“
ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚ã‚Šï¼Ÿ
     â”œâ”€ YES â†’ ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ â†’ ENEMY_SELECT
     â””â”€ NO â†’ TITLE â†’ CHARACTER_SELECT â†’ ENEMY_SELECT
                                              â†“
                                        playerStoreåˆæœŸåŒ–
                                              â†“
                                       æ•µé¸æŠï¼ˆgameStoreï¼‰
                                              â†“
                                    SHOPï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                                              â†“
                                   LEVELUPï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                                              â†“
                                         PLACEMENT
                                              â†“
                                  battleStore.initializeBattle()
                                              â†“
                                          BATTLE
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  ã‚¿ãƒ¼ãƒ³åˆ¶å¾¡     â”‚
                                      â”‚  - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼   â”‚
                                      â”‚  - æ•µAI        â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â†“
                                        å‹æ•—åˆ¤å®š
                                              â†“
                                      battleStore.endBattle()
                                              â†“
                                          RESULT
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  å ±é…¬è¨ˆç®—      â”‚
                                      â”‚  çµŒé¨“å€¤è¨ˆç®—    â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â†“
                                  playerStoreæ›´æ–°ï¼ˆè³é‡‘ãƒ»çµŒé¨“å€¤ï¼‰
                                              â†“
                                  gameStore.markEnemyAsDefeated()
                                              â†“
                                        å…¨æ•µæ’ƒç ´ï¼Ÿ
                                      â”œâ”€ YES â†’ ENDING
                                      â””â”€ NO â†’ ENEMY_SELECT
```

### æˆ¦é—˜ãƒ•ã‚§ãƒ¼ã‚ºè©³ç´°

```
PLACEMENTï¼ˆé…ç½®ãƒ•ã‚§ãƒ¼ã‚ºï¼‰
     â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒéƒ¨éšŠé…ç½®
     â†“
playerStore.placeUnit() Ã— Nå›
     â†“
é…ç½®å®Œäº†
     â†“
BATTLEé–‹å§‹
     â†“
battleStore.initializeBattle()
     â”œâ”€ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”Ÿæˆ
     â”œâ”€ æ•µéƒ¨éšŠé…ç½®ï¼ˆAIï¼‰
     â”œâ”€ å…ˆåˆ¶æ”»æ’ƒåˆ¤å®š
     â””â”€ ã‚¿ãƒ¼ãƒ³è¨­å®š
     â†“
â”Œâ”€â†’ ã‚¿ãƒ¼ãƒ³é–‹å§‹
â”‚    â†“
â”‚ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ or æ•µ
â”‚    â†“
â”‚ attack(position)
â”‚    â†“
â”‚ HIT or MISSï¼Ÿ
â”‚    â”œâ”€ HIT â†’ é€£ç¶šæ”»æ’ƒå¯èƒ½ â”€â”€â”
â”‚    â”‚         â†“             â”‚
â”‚    â”‚    éƒ¨éšŠç ´å£Šï¼Ÿ         â”‚
â”‚    â”‚    â”œâ”€ YES â†’ çµŒé¨“å€¤   â”‚
â”‚    â”‚    â””â”€ NO             â”‚
â”‚    â”‚         â†“             â”‚
â”‚    â”‚    åœ°é›·ï¼Ÿ             â”‚
â”‚    â”‚    â”œâ”€ YES â†’ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ â†’ ã‚¿ãƒ¼ãƒ³äº¤ä»£
â”‚    â”‚    â””â”€ NO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    â”‚
â”‚    â””â”€ MISS â†’ ãƒ€ãƒ¡ãƒ¼ã‚¸ â†’ ã‚¿ãƒ¼ãƒ³äº¤ä»£ â”€â”
â”‚                                    â”‚
â”‚    â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    â†“
â”‚ å‹æ•—åˆ¤å®š
â”‚    â”œâ”€ æ±ºç€ãªã— â”€â”€â”˜
â”‚    â””â”€ æ±ºç€ã‚ã‚Š
â”‚         â†“
â””â”€â†’ RESULT
```

---

## ã‚¹ãƒˆã‚¢é–“ã®é€£æº

### é€£æºãƒ‘ã‚¿ãƒ¼ãƒ³

#### 1. ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚
```typescript
// App.tsx ã¾ãŸã¯ Root Component
useEffect(() => {
  const initGame = async () => {
    // gameStoreåˆæœŸåŒ–
    await gameStore.initializeGame()
    
    // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°playerStoreã‚‚ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿
    if (!gameStore.isFirstLaunch) {
      // ãƒ­ãƒ¼ãƒ‰æˆåŠŸ â†’ ENEMY_SELECTç”»é¢ã¸
      gameStore.navigateTo(GameScreen.ENEMY_SELECT)
    } else {
      // æ–°è¦ â†’ TITLEç”»é¢ã¸
      gameStore.navigateTo(GameScreen.TITLE)
    }
  }
  
  initGame()
}, [])
```

#### 2. æˆ¦é—˜é–‹å§‹æ™‚
```typescript
// Placementç”»é¢ã§ã®ã€Œæˆ¦é—˜é–‹å§‹ã€ãƒœã‚¿ãƒ³
const handleStartBattle = () => {
  const enemy = getEnemyById(gameStore.selectedEnemy!)
  const playerUnits = playerStore.placedUnits
  
  // battleStoreåˆæœŸåŒ–
  battleStore.initializeBattle(enemy, playerUnits)
  
  // ç”»é¢é·ç§»
  gameStore.navigateTo(GameScreen.BATTLE)
}
```

#### 3. æˆ¦é—˜çµ‚äº†æ™‚
```typescript
// battleStore.endBattle() å†…éƒ¨
endBattle: (winner) => {
  const state = get()
  
  // æˆ¦é—˜çµæœã‚’è¨ˆç®—
  const result = calculateBattleResult(state, winner)
  
  set({ battleResult: result })
  
  // playerStoreã‚’æ›´æ–°
  if (winner === 'player') {
    playerStore.addMoney(result.totalReward)
    playerStore.addExp(result.totalExp)
    
    // gameStoreã‚’æ›´æ–°
    gameStore.markEnemyAsDefeated(state.enemy.id)
    gameStore.incrementBattleCount(true)
  } else {
    // æ•—åŒ—æ™‚ã¯çµŒé¨“å€¤ã®ã¿ï¼ˆrequirements.mdã‚ˆã‚Šï¼‰
    playerStore.addExp(result.totalExp)
    gameStore.incrementBattleCount(false)
  }
  
  // ç”»é¢é·ç§»
  gameStore.navigateTo(GameScreen.RESULT)
}
```

#### 4. ã‚»ãƒ¼ãƒ–æ™‚
```typescript
// gameStore.saveGame() å†…éƒ¨
saveGame: async () => {
  const saveData: SaveData = {
    version: '1.0',
    lastSaved: new Date().toISOString(),
    player: playerStore.getPlayerData(),
    progress: get().progress
  }
  
  localStorage.setItem('hardboiled-game-save', JSON.stringify(saveData))
}
```

### ä¾å­˜é–¢ä¿‚å›³

```
gameStore
  â”œâ”€ èª­ã¿å–ã‚Š: playerStoreï¼ˆã‚»ãƒ¼ãƒ–æ™‚ï¼‰
  â””â”€ æ›¸ãè¾¼ã¿: ãªã—

playerStore
  â”œâ”€ èª­ã¿å–ã‚Š: ãªã—
  â””â”€ æ›¸ãè¾¼ã¿: ãªã—ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰

battleStore
  â”œâ”€ èª­ã¿å–ã‚Š: playerStoreï¼ˆåˆæœŸåŒ–æ™‚ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»éƒ¨éšŠã‚’å–å¾—ï¼‰
  â”œâ”€ æ›¸ãè¾¼ã¿: playerStoreï¼ˆæˆ¦é—˜çµ‚äº†æ™‚ã«è³é‡‘ãƒ»çµŒé¨“å€¤ã‚’æ›´æ–°ï¼‰
  â””â”€ æ›¸ãè¾¼ã¿: gameStoreï¼ˆæˆ¦é—˜çµ‚äº†æ™‚ã«é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°ï¼‰
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ
     â†“
Component
     â†“
Store Action
     â†“
Stateæ›´æ–°
     â†“
Componentå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     â†“
UIæ›´æ–°
```

**ä¾‹: æ”»æ’ƒå‡¦ç†**
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯
     â†“
BattleField.tsx
     â†“
battleStore.attack(position)
     â†“
battleStore.stateæ›´æ–°ï¼ˆattackHistoryè¿½åŠ ã€turnå¤‰æ›´ãªã©ï¼‰
     â†“
BattleField.tsxå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     â†“
ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
```

---

## æ°¸ç¶šåŒ–è¨­è¨ˆ

### localStorageæ§‹é€ 

```typescript
// ã‚­ãƒ¼: 'hardboiled-game-save'
// å€¤: JSONæ–‡å­—åˆ—
{
  "version": "1.0",
  "lastSaved": "2025-11-12T10:30:00.000Z",
  "player": {
    "character": "jack",
    "stats": { "HP": 140, "SP": 70, "AT": 20, "DF": 11, "AR": 3 },
    "maxStats": { "maxHP": 140, "maxSP": 70, "maxAT": 20, "maxDF": 11, "maxAR": 11 },
    "levels": { "HP": 3, "SP": 3, "AT": 3, "DF": 3, "AR": 3 },
    "money": 2500,
    "exp": 450,
    "ownedUnits": ["ambulance", "harrier", "fire_truck", "mine", "mine"]
  },
  "progress": {
    "defeatedEnemies": ["carrier_a"],
    "currentEnemy": "madman_b",
    "totalBattles": 3,
    "totalVictories": 2,
    "totalDefeats": 1
  }
}
```

### ã‚»ãƒ¼ãƒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°

1. **è‡ªå‹•ã‚»ãƒ¼ãƒ–**: æˆ¦é—˜çµ‚äº†æ™‚
2. **æ‰‹å‹•ã‚»ãƒ¼ãƒ–**: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œã‚»ãƒ¼ãƒ–ã€é¸æŠæ™‚
3. **ã‚»ãƒ¼ãƒ–ã—ãªã„**: æˆ¦é—˜ä¸­ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‰æˆ¦é—˜å‰ã«æˆ»ã‚‹ï¼‰

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®

### æœ€é©åŒ–æ‰‹æ³•

1. **ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®ä½¿ç”¨**
```typescript
// å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’è³¼èª­
const playerHP = usePlayerStore((state) => state.stats.HP)
const enemyHP = useBattleStore((state) => state.enemyStats.HP)
```

2. **æµ…ã„ç­‰ä¾¡æ€§ãƒã‚§ãƒƒã‚¯**
```typescript
// Zustandã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æµ…ã„ç­‰ä¾¡æ€§ãƒã‚§ãƒƒã‚¯
// ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é˜²ã
```

3. **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®åˆ†å‰²**
```typescript
// å¤§ããªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯åˆ†å‰²ã—ã¦å¿…è¦ãªéƒ¨åˆ†ã®ã¿æ›´æ–°
// ä¾‹: updateStats() ã¨ takeDamage() ã‚’åˆ¥ã€…ã«
```

4. **immerã®æ´»ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**
```typescript
import { produce } from 'immer'

set(produce((draft) => {
  draft.stats.HP -= damage
  draft.attackHistory.push(log)
}))
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

1. **ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ç ´æ**
```typescript
loadGame: async () => {
  try {
    const data = localStorage.getItem('hardboiled-game-save')
    if (!data) return false
    
    const parsed = JSON.parse(data)
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!isValidSaveData(parsed)) {
      console.error('Invalid save data')
      return false
    }
    
    // ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    return true
  } catch (error) {
    console.error('Failed to load save data:', error)
    return false
  }
}
```

2. **ä¸æ­£ãªæ“ä½œ**
```typescript
attack: (position) => {
  // ã‚¬ãƒ¼ãƒ‰å¥ã§ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
  if (!get().isValidPosition(position)) {
    console.warn('Invalid position:', position)
    return { success: false, isHit: false, canContinue: false }
  }
  
  if (get().isAnimating) {
    console.warn('Animation in progress')
    return { success: false, isHit: false, canContinue: false }
  }
  
  // æ­£å¸¸å‡¦ç†
}
```

---

## ãƒ†ã‚¹ãƒˆæ–¹é‡

### å˜ä½“ãƒ†ã‚¹ãƒˆå¯¾è±¡

- å„ã‚¹ãƒˆã‚¢ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
- ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚³ã‚¹ãƒˆè¨ˆç®—
- å‹æ•—åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

### ãƒ†ã‚¹ãƒˆä¾‹

```typescript
describe('playerStore', () => {
  it('should increase HP when leveling up', () => {
    const store = usePlayerStore.getState()
    store.addMoney(100)
    
    const initialHP = store.stats.HP
    const result = store.levelUp('HP')
    
    expect(result).toBe(true)
    expect(store.stats.HP).toBe(initialHP + 20)
    expect(store.levels.HP).toBe(2)
  })
  
  it('should not level up without enough money', () => {
    const store = usePlayerStore.getState()
    store.money = 0
    
    const result = store.levelUp('HP')
    
    expect(result).toBe(false)
    expect(store.levels.HP).toBe(1)
  })
})
```

---

**ä»¥ä¸Šã€çŠ¶æ…‹ç®¡ç†è¨­è¨ˆæ›¸ï¼ˆç¬¬1ç‰ˆï¼‰**