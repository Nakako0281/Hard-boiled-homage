# ãƒ†ã‚¹ãƒˆè¨­è¨ˆæ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**ä½œæˆæ—¥**: 2025å¹´11æœˆ12æ—¥  
**å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: ãƒãƒ¼ãƒ‰ãƒœã‚¤ãƒ«ãƒ‰åˆ‘äº‹é¢¨ã‚²ãƒ¼ãƒ 

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#ãƒ†ã‚¹ãƒˆæˆ¦ç•¥)
2. [ãƒ†ã‚¹ãƒˆç’°å¢ƒ](#ãƒ†ã‚¹ãƒˆç’°å¢ƒ)
3. [ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®æ–¹é‡](#ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®æ–¹é‡)
4. [ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§](#ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§)
5. [E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª](#e2eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª)
6. [ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿](#ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿)
7. [ãƒ†ã‚¹ãƒˆå®Ÿè¡Œè¨ˆç”»](#ãƒ†ã‚¹ãƒˆå®Ÿè¡Œè¨ˆç”»)

---

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   E2E   â”‚  10% - é‡è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒŠãƒªã‚ªã®ã¿
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚çµ±åˆãƒ†ã‚¹ãƒˆ â”‚  20% - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®é€£æº
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ãƒ¦ãƒ‹ãƒƒãƒˆ   â”‚  70% - å€‹åˆ¥ã®é–¢æ•°ãƒ»ãƒ­ã‚¸ãƒƒã‚¯
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ†ã‚¹ãƒˆæ–¹é‡

1. **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆæœ€å„ªå…ˆï¼‰**
   - ã™ã¹ã¦ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚«ãƒãƒ¼
   - ç´”ç²‹é–¢æ•°ã¯100%ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç›®æŒ‡ã™
   - å‰¯ä½œç”¨ã®ã‚ã‚‹å‡¦ç†ã¯ãƒ¢ãƒƒã‚¯åŒ–

2. **çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆä¸­å„ªå…ˆï¼‰**
   - ã‚¹ãƒˆã‚¢é–“ã®é€£æºã‚’ãƒ†ã‚¹ãƒˆ
   - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã‚¹ãƒˆã‚¢ã®é€£æºã‚’ãƒ†ã‚¹ãƒˆ

3. **E2Eãƒ†ã‚¹ãƒˆï¼ˆä½å„ªå…ˆï¼‰**
   - ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹ã®ã¿ãƒ†ã‚¹ãƒˆ
   - å…¨ä½“ã®å‹•ä½œç¢ºèª

### ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

| ã‚«ãƒ†ã‚´ãƒª | ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸ |
|----------|--------------|
| ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° | 100% |
| ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ | 95% |
| ã‚¹ãƒˆã‚¢ï¼ˆçŠ¶æ…‹ç®¡ç†ï¼‰ | 90% |
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | 80% |
| å…¨ä½“ | 85% |

---

## ãƒ†ã‚¹ãƒˆç’°å¢ƒ

### ä½¿ç”¨ãƒ„ãƒ¼ãƒ«

```typescript
// ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- Vitest: ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã€ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³
- @testing-library/react: Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
- @testing-library/user-event: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- Playwright: E2Eãƒ†ã‚¹ãƒˆ

// ãã®ä»–
- @vitest/coverage-v8: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
- msw: APIãƒ¢ãƒƒã‚¯ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
```

### ãƒ†ã‚¹ãƒˆè¨­å®š

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: ['./src/test/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'json'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts',
        '**/*.config.*',
        '**/mockData/',
        '**/constants/'
      ]
    }
  }
})
```

### ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```typescript
// src/test/setup.ts
import '@testing-library/jest-dom'
import { cleanup } from '@testing-library/react'
import { afterEach, vi } from 'vitest'

// å„ãƒ†ã‚¹ãƒˆå¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
afterEach(() => {
  cleanup()
  localStorage.clear()
  vi.clearAllMocks()
})

// localStorageã®ãƒ¢ãƒƒã‚¯ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
const localStorageMock = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn(),
  clear: vi.fn()
}
global.localStorage = localStorageMock as any
```

---

## ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®æ–¹é‡

### ãƒ†ã‚¹ãƒˆã®æ§‹é€ 

```typescript
describe('ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®åå‰', () => {
  // å…±é€šã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  beforeEach(() => {
    // åˆæœŸåŒ–å‡¦ç†
  })
  
  // æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆ
  describe('æ­£å¸¸ç³»', () => {
    it('æ­£å¸¸ãªå…¥åŠ›ã§æœŸå¾…é€šã‚Šã®çµæœã‚’è¿”ã™', () => {
      // Arrange - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
      // Act - ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®å®Ÿè¡Œ
      // Assert - çµæœã®æ¤œè¨¼
    })
  })
  
  // ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆ
  describe('ç•°å¸¸ç³»', () => {
    it('ä¸æ­£ãªå…¥åŠ›ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹', () => {
      // ãƒ†ã‚¹ãƒˆå®Ÿè£…
    })
  })
  
  // ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
  describe('ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹', () => {
    it('å¢ƒç•Œå€¤ã§æ­£ã—ãå‹•ä½œã™ã‚‹', () => {
      // ãƒ†ã‚¹ãƒˆå®Ÿè£…
    })
  })
})
```

### Arrange-Act-Assert ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
it('should calculate damage correctly', () => {
  // Arrange: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
  const attacker = { AT: 20 }
  const defender = { DF: 5 }
  
  // Act: ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®é–¢æ•°ã‚’å®Ÿè¡Œ
  const damage = calculateDamage(attacker, defender)
  
  // Assert: æœŸå¾…å€¤ã¨å®Ÿéš›ã®å€¤ã‚’æ¯”è¼ƒ
  expect(damage).toBeGreaterThanOrEqual(1)
  expect(damage).toBeLessThanOrEqual(25)
})
```

### ãƒ¢ãƒƒã‚¯ã®ä½¿ç”¨

```typescript
// Zustandã‚¹ãƒˆã‚¢ã®ãƒ¢ãƒƒã‚¯
vi.mock('../store/playerStore', () => ({
  usePlayerStore: vi.fn(() => ({
    stats: { HP: 100, SP: 50, AT: 10, DF: 5, AR: 1 },
    money: 1000,
    addMoney: vi.fn()
  }))
}))

// localStorageã®ãƒ¢ãƒƒã‚¯
const mockLocalStorage = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn()
}
Object.defineProperty(window, 'localStorage', {
  value: mockLocalStorage
})
```

---

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§

### 1. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ãƒ†ã‚¹ãƒˆ

#### åº§æ¨™è¨ˆç®—é–¢æ•° (position.ts)

```typescript
describe('position utils', () => {
  describe('isPositionEqual', () => {
    it('åŒã˜åº§æ¨™ã§trueã‚’è¿”ã™', () => {
      expect(isPositionEqual({ x: 1, y: 2 }, { x: 1, y: 2 })).toBe(true)
    })
    
    it('ç•°ãªã‚‹åº§æ¨™ã§falseã‚’è¿”ã™', () => {
      expect(isPositionEqual({ x: 1, y: 2 }, { x: 2, y: 1 })).toBe(false)
    })
  })
  
  describe('isPositionInBounds', () => {
    const gridSize = { width: 10, height: 10 }
    
    it('ç¯„å›²å†…ã®åº§æ¨™ã§trueã‚’è¿”ã™', () => {
      expect(isPositionInBounds({ x: 5, y: 5 }, gridSize)).toBe(true)
    })
    
    it('ç¯„å›²å¤–ã®åº§æ¨™ã§falseã‚’è¿”ã™', () => {
      expect(isPositionInBounds({ x: -1, y: 5 }, gridSize)).toBe(false)
      expect(isPositionInBounds({ x: 5, y: 10 }, gridSize)).toBe(false)
    })
    
    it('å¢ƒç•Œå€¤ã§æ­£ã—ãåˆ¤å®šã™ã‚‹', () => {
      expect(isPositionInBounds({ x: 0, y: 0 }, gridSize)).toBe(true)
      expect(isPositionInBounds({ x: 9, y: 9 }, gridSize)).toBe(true)
    })
  })
  
  describe('getAdjacentPositions', () => {
    it('ä¸­å¤®ã®åº§æ¨™ã§4ã¤ã®éš£æ¥åº§æ¨™ã‚’è¿”ã™', () => {
      const adjacent = getAdjacentPositions({ x: 5, y: 5 }, { width: 10, height: 10 })
      expect(adjacent).toHaveLength(4)
    })
    
    it('è§’ã®åº§æ¨™ã§2ã¤ã®éš£æ¥åº§æ¨™ã‚’è¿”ã™', () => {
      const adjacent = getAdjacentPositions({ x: 0, y: 0 }, { width: 10, height: 10 })
      expect(adjacent).toHaveLength(2)
    })
  })
  
  describe('getDistanceBetween', () => {
    it('ãƒãƒ³ãƒãƒƒã‚¿ãƒ³è·é›¢ã‚’æ­£ã—ãè¨ˆç®—ã™ã‚‹', () => {
      expect(getDistanceBetween({ x: 0, y: 0 }, { x: 3, y: 4 })).toBe(7)
      expect(getDistanceBetween({ x: 5, y: 5 }, { x: 5, y: 5 })).toBe(0)
    })
  })
  
  describe('rotatePosition', () => {
    const unitSize = { width: 3, height: 2 }
    
    it('0åº¦å›è»¢ã§åº§æ¨™ãŒå¤‰ã‚ã‚‰ãªã„', () => {
      const pos = { x: 1, y: 1 }
      const rotated = rotatePosition(pos, Rotation.DEG_0, unitSize)
      expect(rotated).toEqual(pos)
    })
    
    it('90åº¦å›è»¢ã§æ­£ã—ãåº§æ¨™å¤‰æ›ã™ã‚‹', () => {
      const rotated = rotatePosition({ x: 0, y: 0 }, Rotation.DEG_90, unitSize)
      expect(rotated).toEqual({ x: 1, y: 0 })
    })
    
    it('180åº¦å›è»¢ã§æ­£ã—ãåº§æ¨™å¤‰æ›ã™ã‚‹', () => {
      const rotated = rotatePosition({ x: 0, y: 0 }, Rotation.DEG_180, unitSize)
      expect(rotated).toEqual({ x: 2, y: 1 })
    })
  })
})
```

#### ã‚°ãƒªãƒƒãƒ‰æ“ä½œé–¢æ•° (grid.ts)

```typescript
describe('grid utils', () => {
  describe('createEmptyGrid', () => {
    it('æŒ‡å®šã‚µã‚¤ã‚ºã®ç©ºã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆã™ã‚‹', () => {
      const grid = createEmptyGrid({ width: 5, height: 5 })
      
      expect(grid).toHaveLength(5)
      expect(grid[0]).toHaveLength(5)
      expect(grid[0][0].state).toBe(CellState.UNEXPLORED)
    })
  })
  
  describe('getCellAt', () => {
    const grid = createEmptyGrid({ width: 5, height: 5 })
    
    it('æœ‰åŠ¹ãªåº§æ¨™ã§ã‚»ãƒ«ã‚’è¿”ã™', () => {
      const cell = getCellAt(grid, { x: 2, y: 2 })
      expect(cell).not.toBeNull()
      expect(cell?.position).toEqual({ x: 2, y: 2 })
    })
    
    it('ç¯„å›²å¤–ã®åº§æ¨™ã§nullã‚’è¿”ã™', () => {
      expect(getCellAt(grid, { x: -1, y: 0 })).toBeNull()
      expect(getCellAt(grid, { x: 5, y: 5 })).toBeNull()
    })
  })
  
  describe('getUnitOccupiedCells', () => {
    const unit: Unit = {
      id: 'test-unit',
      name: 'Test',
      shape: [[1, 1], [1, 0]],
      size: 3,
      price: 100,
      category: UnitCategory.HEAL
    }
    
    it('å›è»¢ãªã—ã§æ­£ã—ãå æœ‰ã‚»ãƒ«ã‚’è¨ˆç®—ã™ã‚‹', () => {
      const cells = getUnitOccupiedCells(unit, { x: 0, y: 0 }, Rotation.DEG_0)
      
      expect(cells).toHaveLength(3)
      expect(cells).toContainEqual({ x: 0, y: 0 })
      expect(cells).toContainEqual({ x: 1, y: 0 })
      expect(cells).toContainEqual({ x: 0, y: 1 })
    })
    
    it('90åº¦å›è»¢ã§æ­£ã—ãå æœ‰ã‚»ãƒ«ã‚’è¨ˆç®—ã™ã‚‹', () => {
      const cells = getUnitOccupiedCells(unit, { x: 0, y: 0 }, Rotation.DEG_90)
      expect(cells).toHaveLength(3)
    })
  })
  
  describe('canPlaceUnit', () => {
    it('é…ç½®å¯èƒ½ãªå ´åˆtrueã‚’è¿”ã™', () => {
      const field = createMockField({ width: 10, height: 10 })
      const unit = createMockUnit()
      
      expect(canPlaceUnit(unit, { x: 0, y: 0 }, Rotation.DEG_0, field)).toBe(true)
    })
    
    it('ç¯„å›²å¤–ã®å ´åˆfalseã‚’è¿”ã™', () => {
      const field = createMockField({ width: 10, height: 10 })
      const unit = createMockUnit()
      
      expect(canPlaceUnit(unit, { x: 9, y: 9 }, Rotation.DEG_0, field)).toBe(false)
    })
    
    it('æ—¢ã«éƒ¨éšŠãŒã‚ã‚‹å ´åˆfalseã‚’è¿”ã™', () => {
      const field = createMockField({ width: 10, height: 10 })
      const unit = createMockUnit()
      
      // æ—¢ã«éƒ¨éšŠã‚’é…ç½®
      field.cells[0][0].unitId = 'existing-unit'
      
      expect(canPlaceUnit(unit, { x: 0, y: 0 }, Rotation.DEG_0, field)).toBe(false)
    })
  })
})
```

#### é…åˆ—æ“ä½œé–¢æ•° (array.ts)

```typescript
describe('array utils', () => {
  describe('randomChoice', () => {
    it('é…åˆ—ã‹ã‚‰è¦ç´ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã™ã‚‹', () => {
      const array = [1, 2, 3, 4, 5]
      const choice = randomChoice(array)
      
      expect(array).toContain(choice)
    })
    
    it('ç©ºé…åˆ—ã§undefinedã‚’è¿”ã™', () => {
      expect(randomChoice([])).toBeUndefined()
    })
  })
  
  describe('shuffle', () => {
    it('é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹', () => {
      const array = [1, 2, 3, 4, 5]
      const shuffled = shuffle(array)
      
      expect(shuffled).toHaveLength(array.length)
      expect(shuffled.sort()).toEqual(array.sort())
    })
    
    it('å…ƒã®é…åˆ—ã‚’å¤‰æ›´ã—ãªã„', () => {
      const array = [1, 2, 3]
      const original = [...array]
      shuffle(array)
      
      expect(array).toEqual(original)
    })
  })
  
  describe('chunk', () => {
    it('é…åˆ—ã‚’æŒ‡å®šã‚µã‚¤ã‚ºã«åˆ†å‰²ã™ã‚‹', () => {
      const array = [1, 2, 3, 4, 5]
      const chunks = chunk(array, 2)
      
      expect(chunks).toEqual([[1, 2], [3, 4], [5]])
    })
  })
  
  describe('unique', () => {
    it('é‡è¤‡ã‚’å‰Šé™¤ã™ã‚‹', () => {
      const array = [1, 2, 2, 3, 3, 3]
      const uniqueArray = unique(array)
      
      expect(uniqueArray).toEqual([1, 2, 3])
    })
    
    it('ã‚­ãƒ¼é–¢æ•°ã§é‡è¤‡åˆ¤å®šã™ã‚‹', () => {
      const array = [
        { id: 1, name: 'A' },
        { id: 2, name: 'B' },
        { id: 1, name: 'C' }
      ]
      const uniqueArray = unique(array, item => item.id)
      
      expect(uniqueArray).toHaveLength(2)
    })
  })
})
```

#### æ•°å€¤è¨ˆç®—é–¢æ•° (math.ts)

```typescript
describe('math utils', () => {
  describe('clamp', () => {
    it('ç¯„å›²å†…ã®å€¤ã‚’ãã®ã¾ã¾è¿”ã™', () => {
      expect(clamp(5, 0, 10)).toBe(5)
    })
    
    it('æœ€å°å€¤æœªæº€ã‚’æœ€å°å€¤ã«åˆ¶é™ã™ã‚‹', () => {
      expect(clamp(-5, 0, 10)).toBe(0)
    })
    
    it('æœ€å¤§å€¤è¶…éã‚’æœ€å¤§å€¤ã«åˆ¶é™ã™ã‚‹', () => {
      expect(clamp(15, 0, 10)).toBe(10)
    })
  })
  
  describe('isInRange', () => {
    it('ç¯„å›²å†…ã§trueã‚’è¿”ã™', () => {
      expect(isInRange(5, 0, 10)).toBe(true)
    })
    
    it('ç¯„å›²å¤–ã§falseã‚’è¿”ã™', () => {
      expect(isInRange(-1, 0, 10)).toBe(false)
      expect(isInRange(11, 0, 10)).toBe(false)
    })
    
    it('å¢ƒç•Œå€¤ã§æ­£ã—ãåˆ¤å®šã™ã‚‹', () => {
      expect(isInRange(0, 0, 10)).toBe(true)
      expect(isInRange(10, 0, 10)).toBe(true)
    })
  })
  
  describe('randomInt', () => {
    it('æŒ‡å®šç¯„å›²ã®æ•´æ•°ã‚’è¿”ã™', () => {
      const value = randomInt(1, 10)
      
      expect(value).toBeGreaterThanOrEqual(1)
      expect(value).toBeLessThanOrEqual(10)
      expect(Number.isInteger(value)).toBe(true)
    })
  })
  
  describe('percentage', () => {
    it('ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’è¨ˆç®—ã™ã‚‹', () => {
      expect(percentage(50, 100)).toBe(50)
      expect(percentage(25, 100)).toBe(25)
    })
    
    it('æœ€å¤§å€¤0ã§0ã‚’è¿”ã™', () => {
      expect(percentage(50, 0)).toBe(0)
    })
  })
})
```

---

### 2. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ

#### ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®— (damage.ts)

```typescript
describe('damage calculation', () => {
  describe('calculateDamage', () => {
    it('åŸºæœ¬ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’æ­£ã—ãè¨ˆç®—ã™ã‚‹', () => {
      const attacker = { AT: 20 }
      const defender = { DF: 5 }
      
      const damage = calculateDamage(attacker, defender)
      
      // AT Ã— (1 + random(-0.1, 0.1)) - DF
      // æœ€å°: 20 Ã— 0.9 - 5 = 13
      // æœ€å¤§: 20 Ã— 1.1 - 5 = 17
      expect(damage).toBeGreaterThanOrEqual(13)
      expect(damage).toBeLessThanOrEqual(17)
    })
    
    it('æœ€ä½1ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¿è¨¼ã™ã‚‹', () => {
      const attacker = { AT: 1 }
      const defender = { DF: 100 }
      
      const damage = calculateDamage(attacker, defender)
      
      expect(damage).toBe(1)
    })
    
    it('æ”»æ’ƒåŠ›è£œæ­£ã‚’é©ç”¨ã™ã‚‹', () => {
      const attacker = { AT: 20 }
      const defender = { DF: 5 }
      const attackBuffs = 10 // çŸ³æ²¹ã‚¿ãƒ³ã‚«ãƒ¼ãªã©ã®è£œæ­£
      
      const damage = calculateDamage(attacker, defender, attackBuffs, 0)
      
      expect(damage).toBeGreaterThan(calculateDamage(attacker, defender, 0, 0))
    })
    
    it('é˜²å¾¡åŠ›è£œæ­£ã‚’é©ç”¨ã™ã‚‹', () => {
      const attacker = { AT: 20 }
      const defender = { DF: 5 }
      const defenseBuffs = 10 // æ¶ˆé˜²è»Šãªã©ã®è£œæ­£
      
      const damage = calculateDamage(attacker, defender, 0, defenseBuffs)
      
      expect(damage).toBeLessThan(calculateDamage(attacker, defender, 0, 0))
    })
  })
  
  describe('calculateDirectDamage', () => {
    it('MISSæ™‚ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—ã™ã‚‹', () => {
      const attacker = { AT: 20, DF: 5 }
      
      const damage = calculateDirectDamage(attacker)
      
      // AT / 3 - DF / 3
      // 20 / 3 - 5 / 3 = ç´„5
      expect(damage).toBeGreaterThanOrEqual(1)
    })
  })
})
```

#### å ±é…¬è¨ˆç®— (reward.ts)

```typescript
describe('reward calculation', () => {
  describe('calculateReward', () => {
    it('åŸºæœ¬å ±é…¬ã‚’è¨ˆç®—ã™ã‚‹', () => {
      const result = {
        isVictory: true,
        remainingHP: 80,
        unitsDestroyed: 3,
        unitsLost: 1
      }
      const enemy = {
        baseReward: 1000
      }
      const maxHP = 100
      
      const reward = calculateReward(result, enemy, maxHP)
      
      // åŸºæœ¬è³é‡‘ + HPãƒœãƒ¼ãƒŠã‚¹ + éƒ¨éšŠãƒœãƒ¼ãƒŠã‚¹
      expect(reward.totalReward).toBeGreaterThan(enemy.baseReward)
    })
    
    it('HPãƒœãƒ¼ãƒŠã‚¹ã‚’æ­£ã—ãè¨ˆç®—ã™ã‚‹', () => {
      const result = {
        isVictory: true,
        remainingHP: 90,
        unitsDestroyed: 3,
        unitsLost: 1
      }
      
      const reward = calculateReward(result, { baseReward: 1000 }, 100)
      
      // (remainingHP / maxHP) Ã— baseReward
      // (90 / 100) Ã— 1000 = 900
      expect(reward.hpBonus).toBe(900)
    })
    
    it('éƒ¨éšŠãƒœãƒ¼ãƒŠã‚¹ã‚’æ­£ã—ãè¨ˆç®—ã™ã‚‹', () => {
      const result = {
        isVictory: true,
        remainingHP: 80,
        unitsDestroyed: 5,
        unitsLost: 1
      }
      
      const reward = calculateReward(result, { baseReward: 1000 }, 100)
      
      // unitsDestroyed Ã— 100
      expect(reward.unitsBonus).toBe(500)
    })
    
    it('æ•—åŒ—æ™‚ã¯0å††ã‚’è¿”ã™', () => {
      const result = {
        isVictory: false,
        remainingHP: 0,
        unitsDestroyed: 2,
        unitsLost: 5
      }
      
      const reward = calculateReward(result, { baseReward: 1000 }, 100)
      
      expect(reward.totalReward).toBe(0)
    })
  })
  
  describe('calculateExp', () => {
    it('åŸºæœ¬çµŒé¨“å€¤ã‚’è¨ˆç®—ã™ã‚‹', () => {
      const result = {
        isVictory: true,
        unitsDestroyed: 3
      }
      const enemy = {
        baseExp: 100
      }
      
      const exp = calculateExp(result, enemy)
      
      // åŸºæœ¬çµŒé¨“å€¤ + å æœ‰ç‡ãƒœãƒ¼ãƒŠã‚¹ + æ—…å®¢æ©Ÿãƒœãƒ¼ãƒŠã‚¹
      expect(exp.totalExp).toBeGreaterThanOrEqual(enemy.baseExp)
    })
    
    it('å æœ‰ç‡ãƒœãƒ¼ãƒŠã‚¹ã‚’è¨ˆç®—ã™ã‚‹', () => {
      const result = {
        isVictory: true,
        unitsDestroyed: 4,
        hasPassengerPlane: false
      }
      
      const exp = calculateExp(result, { baseExp: 100 })
      
      // unitsDestroyed Ã— 50
      expect(exp.occupancyBonus).toBe(200)
    })
    
    it('æ—…å®¢æ©Ÿãƒœãƒ¼ãƒŠã‚¹ã‚’é©ç”¨ã™ã‚‹', () => {
      const result = {
        isVictory: true,
        unitsDestroyed: 3,
        hasPassengerPlane: true
      }
      
      const expWithPlane = calculateExp(result, { baseExp: 100 })
      
      result.hasPassengerPlane = false
      const expWithoutPlane = calculateExp(result, { baseExp: 100 })
      
      expect(expWithPlane.totalExp).toBe(expWithoutPlane.totalExp * 1.2)
    })
  })
  
  describe('calculateLevelUpCost', () => {
    it('ãƒ¬ãƒ™ãƒ«1ã®ã‚³ã‚¹ãƒˆã‚’è¨ˆç®—ã™ã‚‹', () => {
      const cost = calculateLevelUpCost(StatType.HP, 1)
      
      // 50 Ã— 1.3^1 = 65
      expect(cost).toBe(65)
    })
    
    it('ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã‚‹ã”ã¨ã«ã‚³ã‚¹ãƒˆãŒå¢—åŠ ã™ã‚‹', () => {
      const cost1 = calculateLevelUpCost(StatType.HP, 1)
      const cost2 = calculateLevelUpCost(StatType.HP, 2)
      const cost3 = calculateLevelUpCost(StatType.HP, 3)
      
      expect(cost2).toBeGreaterThan(cost1)
      expect(cost3).toBeGreaterThan(cost2)
    })
    
    it('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã”ã¨ã«åŸºæœ¬ã‚³ã‚¹ãƒˆãŒç•°ãªã‚‹', () => {
      const costHP = calculateLevelUpCost(StatType.HP, 1)
      const costSP = calculateLevelUpCost(StatType.SP, 1)
      const costAR = calculateLevelUpCost(StatType.AR, 1)
      
      expect(costHP).not.toBe(costSP)
      expect(costSP).not.toBe(costAR)
    })
  })
  
  describe('calculateHealCost', () => {
    it('å›å¾©ã‚³ã‚¹ãƒˆã‚’è¨ˆç®—ã™ã‚‹', () => {
      const cost = calculateHealCost(50)
      
      // healAmount Ã— 2
      expect(cost).toBe(100)
    })
  })
})
```

#### å‹æ•—åˆ¤å®š (victory.ts)

```typescript
describe('victory check', () => {
  describe('checkVictory', () => {
    it('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP0ã§æ•µã®å‹åˆ©', () => {
      const state = {
        playerStats: { HP: 0 },
        enemyStats: { HP: 50 },
        playerField: { placedUnits: [{ isDestroyed: false }] },
        enemyField: { placedUnits: [{ isDestroyed: false }] }
      }
      
      expect(checkVictory(state)).toBe('enemy')
    })
    
    it('æ•µHP0ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‹åˆ©', () => {
      const state = {
        playerStats: { HP: 50 },
        enemyStats: { HP: 0 },
        playerField: { placedUnits: [{ isDestroyed: false }] },
        enemyField: { placedUnits: [{ isDestroyed: false }] }
      }
      
      expect(checkVictory(state)).toBe('player')
    })
    
    it('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨éƒ¨éšŠç ´å£Šã§æ•µã®å‹åˆ©', () => {
      const state = {
        playerStats: { HP: 50 },
        enemyStats: { HP: 50 },
        playerField: { placedUnits: [{ isDestroyed: true }, { isDestroyed: true }] },
        enemyField: { placedUnits: [{ isDestroyed: false }] }
      }
      
      expect(checkVictory(state)).toBe('enemy')
    })
    
    it('æ•µå…¨éƒ¨éšŠç ´å£Šã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‹åˆ©', () => {
      const state = {
        playerStats: { HP: 50 },
        enemyStats: { HP: 50 },
        playerField: { placedUnits: [{ isDestroyed: false }] },
        enemyField: { placedUnits: [{ isDestroyed: true }, { isDestroyed: true }] }
      }
      
      expect(checkVictory(state)).toBe('player')
    })
    
    it('æ±ºç€ãŒã¤ã„ã¦ã„ãªã„å ´åˆnullã‚’è¿”ã™', () => {
      const state = {
        playerStats: { HP: 50 },
        enemyStats: { HP: 50 },
        playerField: { placedUnits: [{ isDestroyed: false }] },
        enemyField: { placedUnits: [{ isDestroyed: false }] }
      }
      
      expect(checkVictory(state)).toBeNull()
    })
  })
})
```

---

### 3. çŠ¶æ…‹ç®¡ç†ï¼ˆStoreï¼‰ãƒ†ã‚¹ãƒˆ

#### playerStore

```typescript
describe('playerStore', () => {
  beforeEach(() => {
    // ã‚¹ãƒˆã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
    const store = usePlayerStore.getState()
    store.resetPlayer()
  })
  
  describe('selectCharacter', () => {
    it('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã§ãã‚‹', () => {
      const store = usePlayerStore.getState()
      
      store.selectCharacter(CharacterType.JACK)
      
      expect(store.character).toBe(CharacterType.JACK)
    })
  })
  
  describe('ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—', () => {
    it('ååˆ†ãªè³‡é‡‘ãŒã‚ã‚Œã°ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã§ãã‚‹', () => {
      const store = usePlayerStore.getState()
      store.addMoney(1000)
      
      const initialHP = store.stats.HP
      const initialLevel = store.levels.HP
      
      const success = store.levelUp(StatType.HP)
      
      expect(success).toBe(true)
      expect(store.stats.HP).toBe(initialHP + 20)
      expect(store.levels.HP).toBe(initialLevel + 1)
    })
    
    it('è³‡é‡‘ä¸è¶³ã§ã¯ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã§ããªã„', () => {
      const store = usePlayerStore.getState()
      const initialHP = store.stats.HP
      
      const success = store.levelUp(StatType.HP)
      
      expect(success).toBe(false)
      expect(store.stats.HP).toBe(initialHP)
    })
    
    it('ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ™‚ã«æ­£ã—ãã‚³ã‚¹ãƒˆãŒæ¶ˆè²»ã•ã‚Œã‚‹', () => {
      const store = usePlayerStore.getState()
      store.addMoney(1000)
      
      const initialMoney = store.money
      const cost = store.getLevelUpCost(StatType.HP)
      
      store.levelUp(StatType.HP)
      
      expect(store.money).toBe(initialMoney - cost)
    })
  })
  
  describe('ãƒ€ãƒ¡ãƒ¼ã‚¸ã¨å›å¾©', () => {
    it('ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¦HPãŒæ¸›å°‘ã™ã‚‹', () => {
      const store = usePlayerStore.getState()
      const initialHP = store.stats.HP
      
      store.takeDamage(10)
      
      expect(store.stats.HP).toBe(initialHP - 10)
    })
    
    it('HP0æœªæº€ã«ã¯ãªã‚‰ãªã„', () => {
      const store = usePlayerStore.getState()
      
      store.takeDamage(9999)
      
      expect(store.stats.HP).toBe(0)
    })
    
    it('å›å¾©ã§ãã‚‹', () => {
      const store = usePlayerStore.getState()
      store.takeDamage(50)
      
      const currentHP = store.stats.HP
      const healed = store.heal(30)
      
      expect(healed).toBe(30)
      expect(store.stats.HP).toBe(currentHP + 30)
    })
    
    it('æœ€å¤§HPä»¥ä¸Šã«ã¯å›å¾©ã—ãªã„', () => {
      const store = usePlayerStore.getState()
      const maxHP = store.maxStats.maxHP
      
      const healed = store.heal(9999)
      
      expect(store.stats.HP).toBe(maxHP)
      expect(healed).toBeLessThanOrEqual(maxHP)
    })
  })
  
  describe('SPç®¡ç†', () => {
    it('SPã‚’æ¶ˆè²»ã§ãã‚‹', () => {
      const store = usePlayerStore.getState()
      const initialSP = store.stats.SP
      
      const success = store.consumeSP(10)
      
      expect(success).toBe(true)
      expect(store.stats.SP).toBe(initialSP - 10)
    })
    
    it('SPä¸è¶³ã§ã¯æ¶ˆè²»ã§ããªã„', () => {
      const store = usePlayerStore.getState()
      
      const success = store.consumeSP(9999)
      
      expect(success).toBe(false)
    })
  })
  
  describe('éƒ¨éšŠç®¡ç†', () => {
    it('éƒ¨éšŠã‚’è³¼å…¥ã§ãã‚‹', () => {
      const store = usePlayerStore.getState()
      store.addMoney(1000)
      
      const success = store.buyUnit('ambulance')
      
      expect(success).toBe(true)
      expect(store.ownedUnits).toContain('ambulance')
    })
    
    it('è³‡é‡‘ä¸è¶³ã§ã¯è³¼å…¥ã§ããªã„', () => {
      const store = usePlayerStore.getState()
      
      const success = store.buyUnit('aircraft_carrier')
      
      expect(success).toBe(false)
    })
    
    it('åŒã˜éƒ¨éšŠã‚’è¤‡æ•°è³¼å…¥ã§ãã‚‹ï¼ˆåœ°é›·ç”¨ï¼‰', () => {
      const store = usePlayerStore.getState()
      store.addMoney(10000)
      
      store.buyUnit('mine')
      store.buyUnit('mine')
      
      const count = store.getUnitCount('mine')
      expect(count).toBe(2)
    })
  })
})
```

#### gameStore

```typescript
describe('gameStore', () => {
  beforeEach(() => {
    const store = useGameStore.getState()
    store.resetGame()
  })
  
  describe('ç”»é¢é·ç§»', () => {
    it('ç”»é¢ã‚’é·ç§»ã§ãã‚‹', () => {
      const store = useGameStore.getState()
      
      store.navigateTo(Screen.ENEMY_SELECT)
      
      expect(store.currentScreen).toBe(Screen.ENEMY_SELECT)
    })
  })
  
  describe('é€²è¡ŒçŠ¶æ³ç®¡ç†', () => {
    it('æ•µã‚’å€’ã—ãŸè¨˜éŒ²ã‚’ä¿å­˜ã§ãã‚‹', () => {
      const store = useGameStore.getState()
      
      store.markEnemyAsDefeated(EnemyId.CARRIER_A)
      
      expect(store.progress.defeatedEnemies).toContain(EnemyId.CARRIER_A)
      expect(store.progress.totalVictories).toBe(1)
    })
    
    it('æ•—åŒ—ã‚’è¨˜éŒ²ã§ãã‚‹', () => {
      const store = useGameStore.getState()
      
      store.recordDefeat()
      
      expect(store.progress.totalDefeats).toBe(1)
    })
  })
  
  describe('ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰', () => {
    it('ã‚²ãƒ¼ãƒ ã‚’ã‚»ãƒ¼ãƒ–ã§ãã‚‹', async () => {
      const store = useGameStore.getState()
      
      const success = await store.saveGame()
      
      expect(success).toBe(true)
      expect(localStorage.setItem).toHaveBeenCalled()
    })
    
    it('ã‚²ãƒ¼ãƒ ã‚’ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹', async () => {
      const store = useGameStore.getState()
      
      // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
      const mockData = {
        version: '1.0.0',
        player: { /* ... */ },
        progress: { /* ... */ }
      }
      localStorage.getItem.mockReturnValue(JSON.stringify(mockData))
      
      const success = await store.loadGame()
      
      expect(success).toBe(true)
    })
  })
})
```

#### battleStore

```typescript
describe('battleStore', () => {
  beforeEach(() => {
    const store = useBattleStore.getState()
    // æˆ¦é—˜ã‚’åˆæœŸåŒ–
  })
  
  describe('æˆ¦é—˜åˆæœŸåŒ–', () => {
    it('æˆ¦é—˜ã‚’åˆæœŸåŒ–ã§ãã‚‹', () => {
      const store = useBattleStore.getState()
      const playerStore = usePlayerStore.getState()
      const enemy = ENEMIES[EnemyId.CARRIER_A]
      
      store.initializeBattle(enemy, playerStore.placedUnits)
      
      expect(store.phase).toBe(BattlePhase.BATTLE)
      expect(store.enemy).toBe(enemy)
    })
    
    it('å…ˆåˆ¶æ”»æ’ƒåˆ¤å®šãŒæ­£ã—ãå‹•ä½œã™ã‚‹', () => {
      const store = useBattleStore.getState()
      // ãƒ†ã‚¹ãƒˆå®Ÿè£…
    })
  })
  
  describe('æ”»æ’ƒå‡¦ç†', () => {
    it('HITæ™‚ã«é€£ç¶šæ”»æ’ƒå¯èƒ½', () => {
      const store = useBattleStore.getState()
      
      // éƒ¨éšŠãŒã‚ã‚‹ã‚»ãƒ«ã‚’æ”»æ’ƒ
      const result = store.attack({ x: 0, y: 0 })
      
      expect(result.isHit).toBe(true)
      expect(result.canContinue).toBe(true)
    })
    
    it('MISSæ™‚ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹', () => {
      const store = useBattleStore.getState()
      const initialHP = store.playerStats.HP
      
      // ç©ºã®ã‚»ãƒ«ã‚’æ”»æ’ƒ
      const result = store.attack({ x: 5, y: 5 })
      
      expect(result.isHit).toBe(false)
      expect(store.playerStats.HP).toBeLessThan(initialHP)
    })
    
    it('åœ°é›·è¸ã‚“ã ã‚‰ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ”»æ’ƒã•ã‚Œã‚‹', () => {
      const store = useBattleStore.getState()
      // ãƒ†ã‚¹ãƒˆå®Ÿè£…
    })
  })
  
  describe('ç‰¹æ®Šæ”»æ’ƒ', () => {
    it('SPååˆ†ãªã‚‰ç‰¹æ®Šæ”»æ’ƒã§ãã‚‹', () => {
      const store = useBattleStore.getState()
      store.playerStats.SP = 100
      
      const success = store.executeSpecialAttack('harrier', { x: 5, y: 5 })
      
      expect(success).toBe(true)
    })
    
    it('SPä¸è¶³ã§ã¯ç‰¹æ®Šæ”»æ’ƒã§ããªã„', () => {
      const store = useBattleStore.getState()
      store.playerStats.SP = 0
      
      const success = store.executeSpecialAttack('harrier', { x: 5, y: 5 })
      
      expect(success).toBe(false)
    })
  })
})
```

---

### 4. AIã‚¨ãƒ³ã‚¸ãƒ³ãƒ†ã‚¹ãƒˆ

```typescript
describe('AI Engine', () => {
  describe('balanced AI', () => {
    it('æœªæ¢ç´¢ã‚¨ãƒªã‚¢ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã™ã‚‹', () => {
      const aiState = createMockAIState()
      
      const target = balancedAI(aiState)
      
      expect(isValidPosition(target, aiState.field.size)).toBe(true)
      expect(aiState.field.cells[target.y][target.x].state).toBe(CellState.UNEXPLORED)
    })
  })
  
  describe('aggressive AI', () => {
    it('HITå¾Œã¯å‘¨å›²ã‚’é›†ä¸­æ”»æ’ƒã™ã‚‹', () => {
      const aiState = createMockAIState()
      aiState.lastHitPosition = { x: 5, y: 5 }
      
      const target = aggressiveAI(aiState)
      
      const distance = getDistanceBetween(target, aiState.lastHitPosition)
      expect(distance).toBeLessThanOrEqual(2)
    })
  })
  
  describe('strategic AI', () => {
    it('ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚µãƒ¼ãƒã‚’å®Ÿè¡Œã™ã‚‹', () => {
      const aiState = createMockAIState()
      
      const target = strategicAI(aiState)
      
      // ãƒã‚§ã‚¹ç›¤çŠ¶ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ãƒã‚§ãƒƒã‚¯
      expect((target.x + target.y) % 2).toBe(0)
    })
  })
  
  describe('expert AI', () => {
    it('ç¢ºç‡åˆ†å¸ƒã‹ã‚‰æœ€é©ãªä½ç½®ã‚’é¸æŠã™ã‚‹', () => {
      const aiState = createMockAIState()
      
      const target = expertAI(aiState)
      
      expect(isValidPosition(target, aiState.field.size)).toBe(true)
    })
  })
  
  describe('ç‰¹æ®Šæ”»æ’ƒåˆ¤å®š', () => {
    it('æ¡ä»¶ã‚’æº€ãŸã›ã°ç‰¹æ®Šæ”»æ’ƒã‚’ä½¿ç”¨ã™ã‚‹', () => {
      const state = createMockBattleState()
      state.enemyStats.SP = 60
      state.playerStats.HP = 50
      
      const shouldUse = shouldUseSpecialAttack(state)
      
      // SP50%ä»¥ä¸Šã€ç›¸æ‰‹HP70%ä»¥ä¸‹
      expect(shouldUse).toBeDefined()
    })
  })
})
```

---

### 5. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ

```typescript
describe('GameStorage', () => {
  beforeEach(() => {
    localStorage.clear()
  })
  
  describe('save and load', () => {
    it('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã‚‹', () => {
      const data = { test: 'value' }
      
      const success = GameStorage.set('test-key', data)
      
      expect(success).toBe(true)
      expect(localStorage.setItem).toHaveBeenCalledWith(
        'test-key',
        JSON.stringify(data)
      )
    })
    
    it('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã‚‹', () => {
      const data = { test: 'value' }
      localStorage.getItem.mockReturnValue(JSON.stringify(data))
      
      const loaded = GameStorage.get('test-key', {})
      
      expect(loaded).toEqual(data)
    })
    
    it('ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™', () => {
      const defaultValue = { default: true }
      
      const result = GameStorage.get('nonexistent', defaultValue)
      
      expect(result).toEqual(defaultValue)
    })
  })
  
  describe('validation', () => {
    it('æœ‰åŠ¹ãªã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å…¥ã‚Œã‚‹', () => {
      const validData = createMockSaveData()
      
      expect(validateSaveData(validData)).toBe(true)
    })
    
    it('ç„¡åŠ¹ãªã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ‹’å¦ã™ã‚‹', () => {
      const invalidData = { version: '1.0.0' }
      
      expect(validateSaveData(invalidData)).toBe(false)
    })
  })
  
  describe('migration', () => {
    it('å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹', async () => {
      const oldData = {
        version: '0.9.0',
        player: { /* ... */ }
      }
      
      const migrated = await migrateIfNeeded(oldData)
      
      expect(migrated.version).toBe(SAVE_DATA_VERSION)
    })
  })
})
```

---

### 6. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ

```typescript
describe('BattleField', () => {
  it('ã‚°ãƒªãƒƒãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹', () => {
    render(<BattleField />)
    
    const cells = screen.getAllByTestId('grid-cell')
    expect(cells.length).toBeGreaterThan(0)
  })
  
  it('ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ”»æ’ƒã§ãã‚‹', async () => {
    const user = userEvent.setup()
    render(<BattleField />)
    
    const cell = screen.getByTestId('cell-0-0')
    await user.click(cell)
    
    // æ”»æ’ƒãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
  })
})

describe('UnitInventory', () => {
  it('æ‰€æŒéƒ¨éšŠã‚’è¡¨ç¤ºã™ã‚‹', () => {
    const mockStore = {
      ownedUnits: ['ambulance', 'harrier']
    }
    
    render(<UnitInventory />, {
      wrapper: createMockStoreProvider(mockStore)
    })
    
    expect(screen.getByText('æ•‘æ€¥è»Š')).toBeInTheDocument()
    expect(screen.getByText('ãƒãƒªã‚¢ãƒ¼')).toBeInTheDocument()
  })
})
```

---

## E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### åŸºæœ¬ãƒ•ãƒ­ãƒ¼

#### ã‚·ãƒŠãƒªã‚ª1: æ–°è¦ã‚²ãƒ¼ãƒ é–‹å§‹ã‹ã‚‰åˆæˆ¦å‹åˆ©ã¾ã§

```typescript
test('æ–°è¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦åˆæˆ¦ã«å‹åˆ©ã™ã‚‹', async ({ page }) => {
  // 1. ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢è¡¨ç¤º
  await page.goto('/')
  await expect(page.locator('h1')).toContainText('ãƒãƒ¼ãƒ‰ãƒœã‚¤ãƒ«ãƒ‰åˆ‘äº‹')
  
  // 2. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ
  await page.click('text=ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ')
  await page.click('text=ã‚¸ãƒ£ãƒƒã‚¯åˆ‘äº‹')
  await page.click('text=æ±ºå®š')
  
  // 3. æ•µé¸æŠ
  await expect(page.locator('h2')).toContainText('æ•µé¸æŠ')
  await page.click('text=é‹ã³å±‹A')
  
  // 4. éƒ¨éšŠé…ç½®
  await expect(page.locator('h2')).toContainText('éƒ¨éšŠé…ç½®')
  
  // åˆæœŸéƒ¨éšŠï¼ˆæ•‘æ€¥è»Šï¼‰ã‚’é…ç½®
  await page.click('[data-testid="unit-ambulance"]')
  await page.click('[data-testid="cell-0-0"]')
  
  // æˆ¦é—˜é–‹å§‹
  await page.click('text=æˆ¦é—˜é–‹å§‹')
  
  // 5. æˆ¦é—˜
  await expect(page.locator('h2')).toContainText('æˆ¦é—˜')
  
  // æ”»æ’ƒã‚’ç¹°ã‚Šè¿”ã™ï¼ˆç°¡æ˜“çš„ãªãƒ«ãƒ¼ãƒ—ï¼‰
  for (let i = 0; i < 20; i++) {
    const cells = await page.locator('[data-testid^="enemy-cell"]').all()
    const randomCell = cells[Math.floor(Math.random() * cells.length)]
    await randomCell.click()
    
    // å‹åˆ©åˆ¤å®š
    const resultText = await page.textContent('body')
    if (resultText?.includes('å‹åˆ©')) {
      break
    }
    
    await page.waitForTimeout(500)
  }
  
  // 6. çµæœç”»é¢
  await expect(page.locator('text=å‹åˆ©')).toBeVisible()
  await expect(page.locator('text=ç²å¾—è³é‡‘')).toBeVisible()
})
```

#### ã‚·ãƒŠãƒªã‚ª2: éƒ¨éšŠè³¼å…¥ã¨ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—

```typescript
test('ã‚·ãƒ§ãƒƒãƒ—ã§éƒ¨éšŠã‚’è³¼å…¥ã—ã¦ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã™ã‚‹', async ({ page }) => {
  // åˆæˆ¦ã«å‹åˆ©ã—ã¦ãŠé‡‘ã‚’ç¨¼ãï¼ˆå‰ææ¡ä»¶ï¼‰
  await setupWithInitialVictory(page)
  
  // 1. ã‚·ãƒ§ãƒƒãƒ—ç”»é¢ã¸ç§»å‹•
  await page.click('text=ã‚·ãƒ§ãƒƒãƒ—')
  await expect(page.locator('h2')).toContainText('ã‚·ãƒ§ãƒƒãƒ—')
  
  // 2. éƒ¨éšŠã‚’è³¼å…¥
  await page.click('[data-testid="buy-harrier"]')
  await expect(page.locator('text=ãƒãƒªã‚¢ãƒ¼ã‚’è³¼å…¥ã—ã¾ã—ãŸ')).toBeVisible()
  
  // 3. ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ç”»é¢ã¸ç§»å‹•
  await page.click('text=å¼·åŒ–')
  await expect(page.locator('h2')).toContainText('å¼·åŒ–')
  
  // 4. HPã‚’ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
  await page.click('[data-testid="levelup-HP"]')
  await expect(page.locator('text=HPãŒãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ')).toBeVisible()
})
```

#### ã‚·ãƒŠãƒªã‚ª3: ç‰¹æ®Šæ”»æ’ƒã®ä½¿ç”¨

```typescript
test('æˆ¦é—˜ã§ç‰¹æ®Šæ”»æ’ƒã‚’ä½¿ç”¨ã™ã‚‹', async ({ page }) => {
  // ãƒãƒªã‚¢ãƒ¼ã‚’æ‰€æŒã—ã¦ã„ã‚‹çŠ¶æ…‹ã§æˆ¦é—˜é–‹å§‹
  await setupWithHarrier(page)
  
  // æˆ¦é—˜ç”»é¢
  await expect(page.locator('h2')).toContainText('æˆ¦é—˜')
  
  // SPã‚’è²¯ã‚ã‚‹ï¼ˆä½•å›ã‹æ”»æ’ƒï¼‰
  for (let i = 0; i < 5; i++) {
    const cell = page.locator('[data-testid="enemy-cell-0-0"]')
    await cell.click()
    await page.waitForTimeout(500)
  }
  
  // ç‰¹æ®Šæ”»æ’ƒã‚’é–‹ã
  await page.click('text=ç‰¹æ®Šæ”»æ’ƒ')
  
  // åå­—çˆ†æ’ƒã‚’é¸æŠ
  await page.click('text=åå­—çˆ†æ’ƒ')
  
  // åº§æ¨™ã‚’é¸æŠ
  await page.click('[data-testid="enemy-cell-5-5"]')
  
  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
  await expect(page.locator('[data-testid="special-effect"]')).toBeVisible()
})
```

#### ã‚·ãƒŠãƒªã‚ª4: ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰

```typescript
test('ã‚²ãƒ¼ãƒ ã‚’ã‚»ãƒ¼ãƒ–ã—ã¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹', async ({ page }) => {
  // 1. ã‚²ãƒ¼ãƒ ã‚’é€²è¡Œ
  await page.goto('/')
  await startNewGame(page)
  await winFirstBattle(page)
  
  // 2. æ‰‹å‹•ã‚»ãƒ¼ãƒ–
  await page.click('text=ãƒ¡ãƒ‹ãƒ¥ãƒ¼')
  await page.click('text=ã‚»ãƒ¼ãƒ–')
  await expect(page.locator('text=ä¿å­˜ã—ã¾ã—ãŸ')).toBeVisible()
  
  // 3. ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
  await page.reload()
  
  // 4. ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰
  await expect(page.locator('h2')).toContainText('æ•µé¸æŠ')
  
  // æ‰€æŒé‡‘ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  await expect(page.locator('[data-testid="money"]')).not.toContainText('0å††')
})
```

#### ã‚·ãƒŠãƒªã‚ª5: å…¨æ•µæ’ƒç ´ã—ã¦ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°

```typescript
test('å…¨æ•µã‚’æ’ƒç ´ã—ã¦ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¦‹ã‚‹', async ({ page }) => {
  // 1. æ–°è¦ã‚²ãƒ¼ãƒ é–‹å§‹
  await page.goto('/')
  await startNewGame(page)
  
  // 2. æ•µã‚’é †ç•ªã«æ’ƒç ´
  const enemies = ['é‹ã³å±‹A', 'ç‹‚äººB', 'Zå¤§ä½', 'çˆ†å¼¾é­”J']
  
  for (const enemy of enemies) {
    // æ•µé¸æŠ
    await page.click(`text=${enemy}`)
    
    // éƒ¨éšŠé…ç½®ï¼ˆç°¡æ˜“çš„ã«ï¼‰
    await placeUnits(page)
    await page.click('text=æˆ¦é—˜é–‹å§‹')
    
    // æˆ¦é—˜ï¼ˆå‹åˆ©ã¾ã§ï¼‰
    await fightUntilVictory(page)
    
    // çµæœç”»é¢ã§æ¬¡ã¸
    await page.click('text=æ¬¡ã¸')
  }
  
  // 3. ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  await expect(page.locator('h2')).toContainText('ENDING')
  await expect(page.locator('text=ã™ã¹ã¦ã®æ•µã‚’å€’ã—ã¾ã—ãŸ')).toBeVisible()
})
```

---

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ

#### ã‚·ãƒŠãƒªã‚ª6: è³‡é‡‘ä¸è¶³ã§è³¼å…¥ã§ããªã„

```typescript
test('è³‡é‡‘ä¸è¶³ã§éƒ¨éšŠã‚’è³¼å…¥ã§ããªã„', async ({ page }) => {
  await setupWithNoMoney(page)
  
  await page.click('text=ã‚·ãƒ§ãƒƒãƒ—')
  await page.click('[data-testid="buy-aircraft-carrier"]')
  
  await expect(page.locator('text=è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™')).toBeVisible()
})
```

#### ã‚·ãƒŠãƒªã‚ª7: SPä¸è¶³ã§ç‰¹æ®Šæ”»æ’ƒã§ããªã„

```typescript
test('SPä¸è¶³ã§ç‰¹æ®Šæ”»æ’ƒã§ããªã„', async ({ page }) => {
  await setupInBattle(page)
  
  await page.click('text=ç‰¹æ®Šæ”»æ’ƒ')
  await page.click('text=åå­—çˆ†æ’ƒ')
  
  await expect(page.locator('text=SPãŒä¸è¶³ã—ã¦ã„ã¾ã™')).toBeVisible()
})
```

---

### ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ†ã‚¹ãƒˆ

#### ã‚·ãƒŠãƒªã‚ª8: ãƒ¢ãƒã‚¤ãƒ«ç”»é¢ã§æ“ä½œ

```typescript
test('ãƒ¢ãƒã‚¤ãƒ«ç”»é¢ã§æ­£å¸¸ã«æ“ä½œã§ãã‚‹', async ({ page }) => {
  await page.setViewportSize({ width: 375, height: 667 })
  
  await page.goto('/')
  await startNewGame(page)
  
  // ã‚¿ãƒƒãƒæ“ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
  await page.tap('[data-testid="unit-ambulance"]')
  await page.tap('[data-testid="cell-0-0"]')
  
  await expect(page.locator('text=é…ç½®å®Œäº†')).toBeVisible()
})
```

---

## ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

### ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ä½œæˆé–¢æ•°

```typescript
// src/test/mockData.ts

export function createMockPosition(x = 0, y = 0): Position {
  return { x, y }
}

export function createMockUnit(overrides?: Partial<Unit>): Unit {
  return {
    id: 'test-unit',
    name: 'ãƒ†ã‚¹ãƒˆéƒ¨éšŠ',
    shape: [[1, 1]],
    size: 2,
    price: 100,
    category: UnitCategory.HEAL,
    description: 'ãƒ†ã‚¹ãƒˆç”¨',
    maxPlacement: 1,
    ...overrides
  }
}

export function createMockPlacedUnit(overrides?: Partial<PlacedUnit>): PlacedUnit {
  return {
    unitId: 'test-unit',
    position: { x: 0, y: 0 },
    rotation: Rotation.DEG_0,
    occupiedCells: [{ x: 0, y: 0 }, { x: 1, y: 0 }],
    hitCells: [],
    isDestroyed: false,
    ...overrides
  }
}

export function createMockField(size?: GridSize): Field {
  const gridSize = size || { width: 10, height: 10 }
  
  return {
    size: gridSize,
    cells: createEmptyGrid(gridSize),
    placedUnits: []
  }
}

export function createMockBattleState(overrides?: Partial<BattleState>): BattleState {
  return {
    phase: BattlePhase.BATTLE,
    turn: Turn.PLAYER,
    playerField: createMockField(),
    enemyField: createMockField(),
    playerStats: { HP: 100, SP: 50, AT: 10, DF: 5, AR: 1 },
    enemyStats: { HP: 100, SP: 50, AT: 10, DF: 5, AR: 1 },
    enemy: ENEMIES[EnemyId.CARRIER_A],
    attackHistory: [],
    canContinueAttack: false,
    consecutiveHits: 0,
    activeSpecialAttack: null,
    specialAttackUsageCount: { player: {}, enemy: {} },
    battleResult: null,
    isAnimating: false,
    ...overrides
  }
}

export function createMockSaveData(overrides?: Partial<SaveData>): SaveData {
  return {
    version: '1.0.0',
    lastSaved: new Date().toISOString(),
    saveId: 'test-save-id',
    player: {
      character: CharacterType.JACK,
      stats: { HP: 100, SP: 50, AT: 10, DF: 5, AR: 1 },
      maxStats: { maxHP: 100, maxSP: 50, maxAT: 10, maxDF: 5, maxAR: 11 },
      levels: { HP: 1, SP: 1, AT: 1, DF: 1, AR: 1 },
      money: 0,
      exp: 0,
      ownedUnits: []
    },
    progress: {
      defeatedEnemies: [],
      totalBattles: 0,
      totalVictories: 0,
      totalDefeats: 0
    },
    ...overrides
  }
}
```

---

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œè¨ˆç”»

### é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºã§ã®ãƒ†ã‚¹ãƒˆ

```bash
# é–‹ç™ºä¸­ã¯watchãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
npm run test:watch

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ†ã‚¹ãƒˆ
npm run test:changed

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§å®Ÿè¡Œ
npm run test:coverage
```

### CI/CDã§ã®ãƒ†ã‚¹ãƒˆ

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test:coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
      
      - name: Run E2E tests
        run: npm run test:e2e
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```json
// package.json
{
  "scripts": {
    "test": "vitest",
    "test:watch": "vitest --watch",
    "test:coverage": "vitest --coverage",
    "test:changed": "vitest --changed",
    "test:e2e": "playwright test",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:debug": "playwright test --debug"
  }
}
```

---

## ãƒ†ã‚¹ãƒˆå“è³ªåŸºæº–

### å¿…é ˆé …ç›®

- [ ] ã™ã¹ã¦ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç›®æ¨™å€¤ä»¥ä¸Š
- [ ] E2Eãƒ†ã‚¹ãƒˆã®ä¸»è¦ã‚·ãƒŠãƒªã‚ªãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹

### æ¨å¥¨é …ç›®

- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹
- [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### å•é¡Œ1: ãƒ†ã‚¹ãƒˆãŒä¸å®‰å®šï¼ˆãƒ•ãƒ¬ãƒ¼ã‚­ãƒ¼ï¼‰

**åŸå› **: éåŒæœŸå‡¦ç†ã®å¾…æ©Ÿä¸è¶³ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä¾å­˜

**è§£æ±ºæ–¹æ³•**:
```typescript
// âŒ æ‚ªã„ä¾‹
await page.click('button')
expect(result).toBe(expected)

// âœ… è‰¯ã„ä¾‹
await page.click('button')
await page.waitForSelector('[data-testid="result"]')
expect(result).toBe(expected)
```

#### å•é¡Œ2: ãƒ¢ãƒƒã‚¯ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œãªã„

**åŸå› **: afterEachã§ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸è¶³

**è§£æ±ºæ–¹æ³•**:
```typescript
afterEach(() => {
  vi.clearAllMocks()
  cleanup()
  localStorage.clear()
})
```

#### å•é¡Œ3: E2Eãƒ†ã‚¹ãƒˆãŒé…ã„

**åŸå› **: ä¸è¦ãªå¾…æ©Ÿã€ä¸¦åˆ—å®Ÿè¡Œã—ã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:
```typescript
// playwright.config.ts
export default {
  workers: 4,  // ä¸¦åˆ—å®Ÿè¡Œ
  timeout: 30000,  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆçŸ­ç¸®
  use: {
    headless: true,  // ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹å®Ÿè¡Œ
    video: 'retain-on-failure'  // å¤±æ•—æ™‚ã®ã¿éŒ²ç”»
  }
}
```

---

**ä»¥ä¸Šã€ãƒ†ã‚¹ãƒˆè¨­è¨ˆæ›¸ï¼ˆç¬¬1ç‰ˆï¼‰**
