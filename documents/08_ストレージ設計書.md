# ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆæ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**ä½œæˆæ—¥**: 2025å¹´11æœˆ12æ—¥  
**å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: ãƒãƒ¼ãƒ‰ãƒœã‚¤ãƒ«ãƒ‰åˆ‘äº‹é¢¨ã‚²ãƒ¼ãƒ 

---

## ğŸ“‹ ç›®æ¬¡

1. [ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆæ–¹é‡](#ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆæ–¹é‡)
2. [localStorageã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ](#localstorageã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ )
3. [ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰å‡¦ç†ãƒ•ãƒ­ãƒ¼](#ã‚»ãƒ¼ãƒ–ãƒ­ãƒ¼ãƒ‰å‡¦ç†ãƒ•ãƒ­ãƒ¼)
4. [ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–¹é‡](#ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–¹é‡)
5. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
6. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
7. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®)

---

## ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆæ–¹é‡

### æ¡ç”¨æŠ€è¡“

- **localStorage**: ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–APIã‚’ä½¿ç”¨
- **JSONå½¢å¼**: ãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º/ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã®ãŸã‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’ä»˜ä¸

### åŸºæœ¬æ–¹é‡

1. **ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ **
   - å˜ä¸€ã®ã‚­ãƒ¼ã§ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
   - JSONã§è¡¨ç¾å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã®ã¿æ‰±ã†

2. **ã‚»ãƒ¼ãƒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°**
   - æˆ¦é—˜çµ‚äº†æ™‚ã«è‡ªå‹•ã‚»ãƒ¼ãƒ–
   - ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ‰‹å‹•ã‚»ãƒ¼ãƒ–å¯èƒ½
   - æˆ¦é—˜ä¸­ã¯ã‚»ãƒ¼ãƒ–ã—ãªã„ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã§æˆ¦é—˜å‰ã«æˆ»ã‚‹ï¼‰

3. **äº’æ›æ€§ç¶­æŒ**
   - ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã§ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤‰æ›´ã‚’ç®¡ç†
   - å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ

4. **ã‚¨ãƒ©ãƒ¼è€æ€§**
   - ç ´æãƒ‡ãƒ¼ã‚¿ã®æ¤œå‡ºã¨å›å¾©
   - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã®å®Ÿè£…

### ä¿å­˜å¯¾è±¡

| ãƒ‡ãƒ¼ã‚¿ | ä¿å­˜å¯¾è±¡ | ç†ç”± |
|--------|---------|------|
| ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | â—‹ | é€²è¡ŒçŠ¶æ³ã®æ°¸ç¶šåŒ–ã«å¿…é ˆ |
| æ‰€æŒé‡‘ãƒ»çµŒé¨“å€¤ | â—‹ | é€²è¡ŒçŠ¶æ³ã®æ°¸ç¶šåŒ–ã«å¿…é ˆ |
| æ‰€æŒéƒ¨éšŠ | â—‹ | é€²è¡ŒçŠ¶æ³ã®æ°¸ç¶šåŒ–ã«å¿…é ˆ |
| ã‚²ãƒ¼ãƒ é€²è¡ŒçŠ¶æ³ | â—‹ | ã‚¯ãƒªã‚¢æ¸ˆã¿æ•µã®è¨˜éŒ² |
| æˆ¦é—˜ä¸­ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰çŠ¶æ…‹ | Ã— | ãƒªãƒ­ãƒ¼ãƒ‰ã§æˆ¦é—˜å‰ã«æˆ»ã™ä»•æ§˜ |
| è¨­å®šï¼ˆéŸ³é‡ãªã©ï¼‰ | â—‹ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š |

---

## localStorageã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼

```typescript
// ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚­ãƒ¼
const STORAGE_KEYS = {
  GAME_SAVE: 'hardboiled-game-save',    // ãƒ¡ã‚¤ãƒ³ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿
  SETTINGS: 'hardboiled-settings',       // è¨­å®šãƒ‡ãƒ¼ã‚¿
  BACKUP: 'hardboiled-backup'            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
} as const
```

### SaveDataæ§‹é€ ï¼ˆè©³ç´°ç‰ˆï¼‰

```typescript
interface SaveData {
  // ãƒ¡ã‚¿æƒ…å ±
  version: string              // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹: "1.0.0"ï¼‰
  lastSaved: string            // æœ€çµ‚ä¿å­˜æ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰
  saveId: string               // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ„IDï¼ˆUUIDï¼‰
  
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿
  player: {
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
    character: CharacterType   // é¸æŠã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    stats: {
      HP: number               // ç¾åœ¨HP
      SP: number               // ç¾åœ¨SP
      AT: number               // æ”»æ’ƒåŠ›
      DF: number               // é˜²å¾¡åŠ›
      AR: number               // ã‚¨ãƒªã‚¢ãƒ¬ãƒ™ãƒ«
    }
    
    // æœ€å¤§å€¤
    maxStats: {
      maxHP: number
      maxSP: number
      maxAT: number            // å­˜åœ¨ã—ãªã„ãŒçµ±ä¸€æ€§ã®ãŸã‚
      maxDF: number            // å­˜åœ¨ã—ãªã„ãŒçµ±ä¸€æ€§ã®ãŸã‚
      maxAR: number
    }
    
    // ãƒ¬ãƒ™ãƒ«
    levels: {
      HP: number               // HPãƒ¬ãƒ™ãƒ«
      SP: number               // SPãƒ¬ãƒ™ãƒ«
      AT: number               // ATãƒ¬ãƒ™ãƒ«
      DF: number               // DFãƒ¬ãƒ™ãƒ«
      AR: number               // ARãƒ¬ãƒ™ãƒ«
    }
    
    // çµŒæ¸ˆ
    money: number              // æ‰€æŒé‡‘
    exp: number                // çµŒé¨“å€¤
    
    // éƒ¨éšŠ
    ownedUnits: string[]       // æ‰€æŒéƒ¨éšŠIDã®é…åˆ—
  }
  
  // ã‚²ãƒ¼ãƒ é€²è¡ŒçŠ¶æ³
  progress: {
    defeatedEnemies: EnemyId[] // å€’ã—ãŸæ•µã®IDãƒªã‚¹ãƒˆ
    currentEnemy?: EnemyId     // ç¾åœ¨å¯¾æˆ¦ä¸­ã®æ•µï¼ˆæˆ¦é—˜æº–å‚™ä¸­ã®ã¿ï¼‰
    totalBattles: number       // ç·æˆ¦é—˜å›æ•°
    totalVictories: number     // ç·å‹åˆ©å›æ•°
    totalDefeats: number       // ç·æ•—åŒ—å›æ•°
  }
  
  // çµ±è¨ˆæƒ…å ±ï¼ˆæ‹¡å¼µç”¨ï¼‰
  statistics?: {
    totalDamageDealt: number   // ç·ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸
    totalDamageReceived: number // ç·è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸
    totalMoneyEarned: number   // ç·ç²å¾—é‡‘é¡
    totalExpEarned: number     // ç·ç²å¾—çµŒé¨“å€¤
    playTime: number           // ç·ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼ˆç§’ï¼‰
    firstPlayedAt?: string     // åˆå›ãƒ—ãƒ¬ã‚¤æ—¥æ™‚
  }
}
```

### Settingsæ§‹é€ 

```typescript
interface Settings {
  version: string              // è¨­å®šãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³
  
  // éŸ³é‡è¨­å®š
  audio: {
    masterVolume: number       // ãƒã‚¹ã‚¿ãƒ¼éŸ³é‡ï¼ˆ0-1ï¼‰
    sfxVolume: number          // åŠ¹æœéŸ³éŸ³é‡ï¼ˆ0-1ï¼‰
    bgmVolume: number          // BGMéŸ³é‡ï¼ˆ0-1ï¼‰
    muted: boolean             // ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹
  }
  
  // è¡¨ç¤ºè¨­å®š
  display: {
    showGrid: boolean          // ã‚°ãƒªãƒƒãƒ‰ç·šè¡¨ç¤º
    showCoordinates: boolean   // åº§æ¨™è¡¨ç¤º
    animationSpeed: 'slow' | 'normal' | 'fast'  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦
    theme: 'dark' | 'light'    // ãƒ†ãƒ¼ãƒï¼ˆãƒ€ãƒ¼ã‚¯å›ºå®šã ãŒæ‹¡å¼µç”¨ï¼‰
  }
  
  // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤è¨­å®š
  gameplay: {
    confirmAttack: boolean     // æ”»æ’ƒå‰ã«ç¢ºèª
    autoSave: boolean          // è‡ªå‹•ã‚»ãƒ¼ãƒ–æœ‰åŠ¹
    skipAnimations: boolean    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒƒãƒ—
  }
}
```

### ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºè©¦ç®—

```typescript
// å…¸å‹çš„ãªã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚º
const ESTIMATED_SIZE = {
  SaveData: '~2KB',           // ãƒ¡ã‚¤ãƒ³ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿
  Settings: '~0.5KB',         // è¨­å®šãƒ‡ãƒ¼ã‚¿
  Total: '~2.5KB'             // åˆè¨ˆ
}

// localStorageã®ä¸Šé™: 5-10MBï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã‚‹ï¼‰
// æœ¬ã‚²ãƒ¼ãƒ ã®ä½¿ç”¨é‡: ç´„2.5KBï¼ˆååˆ†ã«ä½™è£•ã‚ã‚Šï¼‰
```

---

## ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰å‡¦ç†ãƒ•ãƒ­ãƒ¼

### ã‚»ãƒ¼ãƒ–å‡¦ç†ãƒ•ãƒ­ãƒ¼

```typescript
/**
 * ã‚»ãƒ¼ãƒ–å‡¦ç†ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼
 */
async function saveGame(): Promise<boolean> {
  try {
    // 1. ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    const saveData = collectSaveData()
    
    // 2. ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
    if (!validateSaveData(saveData)) {
      throw new Error('Invalid save data')
    }
    
    // 3. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    await backupExistingData()
    
    // 4. ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
    const serialized = JSON.stringify(saveData, null, 2)
    
    // 5. localStorageã«ä¿å­˜
    localStorage.setItem(STORAGE_KEYS.GAME_SAVE, serialized)
    
    // 6. ä¿å­˜æˆåŠŸã®ãƒ­ã‚°
    console.log('Game saved successfully', {
      version: saveData.version,
      timestamp: saveData.lastSaved
    })
    
    return true
    
  } catch (error) {
    console.error('Failed to save game:', error)
    
    // 7. ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
    await restoreFromBackup()
    
    return false
  }
}
```

#### collectSaveDataï¼ˆãƒ‡ãƒ¼ã‚¿åé›†ï¼‰

```typescript
/**
 * å„ã‚¹ãƒˆã‚¢ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¦SaveDataã‚’æ§‹ç¯‰
 */
function collectSaveData(): SaveData {
  const playerStore = usePlayerStore.getState()
  const gameStore = useGameStore.getState()
  
  return {
    // ãƒ¡ã‚¿æƒ…å ±
    version: SAVE_DATA_VERSION,
    lastSaved: new Date().toISOString(),
    saveId: generateSaveId(),
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿
    player: {
      character: playerStore.character!,
      stats: { ...playerStore.stats },
      maxStats: { ...playerStore.maxStats },
      levels: { ...playerStore.levels },
      money: playerStore.money,
      exp: playerStore.exp,
      ownedUnits: [...playerStore.ownedUnits]
    },
    
    // é€²è¡ŒçŠ¶æ³
    progress: {
      defeatedEnemies: [...gameStore.progress.defeatedEnemies],
      currentEnemy: gameStore.progress.currentEnemy,
      totalBattles: gameStore.progress.totalBattles,
      totalVictories: gameStore.progress.totalVictories,
      totalDefeats: gameStore.progress.totalDefeats
    },
    
    // çµ±è¨ˆæƒ…å ±
    statistics: collectStatistics()
  }
}
```

#### validateSaveDataï¼ˆãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ï¼‰

```typescript
/**
 * ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ã‚’æ¤œè¨¼
 */
function validateSaveData(data: unknown): data is SaveData {
  if (!data || typeof data !== 'object') return false
  
  const saveData = data as SaveData
  
  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
  if (!saveData.version || typeof saveData.version !== 'string') {
    return false
  }
  
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
  if (!saveData.player || typeof saveData.player !== 'object') {
    return false
  }
  
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãƒã‚§ãƒƒã‚¯
  if (!['jack', 'gaprino'].includes(saveData.player.character)) {
    return false
  }
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ãƒã‚§ãƒƒã‚¯
  const stats = saveData.player.stats
  if (!stats || 
      typeof stats.HP !== 'number' ||
      typeof stats.SP !== 'number' ||
      typeof stats.AT !== 'number' ||
      typeof stats.DF !== 'number' ||
      typeof stats.AR !== 'number') {
    return false
  }
  
  // æ‰€æŒé‡‘ãƒ»çµŒé¨“å€¤ãƒã‚§ãƒƒã‚¯
  if (typeof saveData.player.money !== 'number' ||
      typeof saveData.player.exp !== 'number') {
    return false
  }
  
  // æ‰€æŒéƒ¨éšŠãƒã‚§ãƒƒã‚¯
  if (!Array.isArray(saveData.player.ownedUnits)) {
    return false
  }
  
  // é€²è¡ŒçŠ¶æ³ãƒã‚§ãƒƒã‚¯
  if (!saveData.progress || typeof saveData.progress !== 'object') {
    return false
  }
  
  if (!Array.isArray(saveData.progress.defeatedEnemies)) {
    return false
  }
  
  return true
}
```

---

### ãƒ­ãƒ¼ãƒ‰å‡¦ç†ãƒ•ãƒ­ãƒ¼

```typescript
/**
 * ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼
 */
async function loadGame(): Promise<boolean> {
  try {
    // 1. localStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
    const rawData = localStorage.getItem(STORAGE_KEYS.GAME_SAVE)
    
    // 2. ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆ
    if (!rawData) {
      console.log('No save data found')
      return false
    }
    
    // 3. JSONãƒ‘ãƒ¼ã‚¹
    const parsedData = JSON.parse(rawData)
    
    // 4. ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
    if (!validateSaveData(parsedData)) {
      throw new Error('Invalid save data format')
    }
    
    // 5. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ï¼†ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    const migratedData = await migrateIfNeeded(parsedData)
    
    // 6. å„ã‚¹ãƒˆã‚¢ã«ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
    applyLoadedData(migratedData)
    
    // 7. ãƒ­ãƒ¼ãƒ‰æˆåŠŸã®ãƒ­ã‚°
    console.log('Game loaded successfully', {
      version: migratedData.version,
      lastSaved: migratedData.lastSaved
    })
    
    return true
    
  } catch (error) {
    console.error('Failed to load game:', error)
    
    // 8. ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã‚‹
    const backupRestored = await tryRestoreFromBackup()
    
    if (!backupRestored) {
      // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚‚å¤±æ•—ã—ãŸã‚‰æ–°è¦ã‚²ãƒ¼ãƒ 
      console.warn('Starting new game due to load failure')
      return false
    }
    
    return true
  }
}
```

#### applyLoadedDataï¼ˆãƒ‡ãƒ¼ã‚¿é©ç”¨ï¼‰

```typescript
/**
 * ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å„ã‚¹ãƒˆã‚¢ã«é©ç”¨
 */
function applyLoadedData(saveData: SaveData): void {
  const playerStore = usePlayerStore.getState()
  const gameStore = useGameStore.getState()
  
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
  playerStore.loadPlayerData({
    character: saveData.player.character,
    stats: saveData.player.stats,
    maxStats: saveData.player.maxStats,
    levels: saveData.player.levels,
    money: saveData.player.money,
    exp: saveData.player.exp,
    ownedUnits: saveData.player.ownedUnits
  })
  
  // ã‚²ãƒ¼ãƒ é€²è¡ŒçŠ¶æ³ã‚’å¾©å…ƒ
  gameStore.loadProgress(saveData.progress)
  
  // çµ±è¨ˆæƒ…å ±ã‚’å¾©å…ƒï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  if (saveData.statistics) {
    gameStore.loadStatistics(saveData.statistics)
  }
}
```

---

### ã‚»ãƒ¼ãƒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°

#### è‡ªå‹•ã‚»ãƒ¼ãƒ–

```typescript
/**
 * æˆ¦é—˜çµ‚äº†æ™‚ã®è‡ªå‹•ã‚»ãƒ¼ãƒ–
 */
function onBattleEnd(result: BattleResult): void {
  // å ±é…¬ãƒ»çµŒé¨“å€¤ã‚’ä»˜ä¸
  applyBattleRewards(result)
  
  // ã‚²ãƒ¼ãƒ é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°
  updateGameProgress(result)
  
  // è‡ªå‹•ã‚»ãƒ¼ãƒ–å®Ÿè¡Œ
  if (getSettings().gameplay.autoSave) {
    saveGame()
      .then(success => {
        if (success) {
          showNotification('ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success')
        } else {
          showNotification('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
        }
      })
  }
}
```

#### æ‰‹å‹•ã‚»ãƒ¼ãƒ–

```typescript
/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã®æ‰‹å‹•ã‚»ãƒ¼ãƒ–
 */
function onManualSave(): void {
  // æˆ¦é—˜ä¸­ã¯ä¿å­˜ã§ããªã„
  if (battleStore.phase === BattlePhase.BATTLE) {
    showNotification('æˆ¦é—˜ä¸­ã¯ä¿å­˜ã§ãã¾ã›ã‚“', 'warning')
    return
  }
  
  // ã‚»ãƒ¼ãƒ–ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  showConfirmDialog({
    title: 'ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜',
    message: 'ç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ',
    onConfirm: async () => {
      const success = await saveGame()
      
      if (success) {
        showNotification('ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success')
      } else {
        showNotification('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      }
    }
  })
}
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–¹é‡

### ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥

```typescript
// ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
const SAVE_DATA_VERSION = '1.0.0'

// ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒ
function compareVersions(v1: string, v2: string): number {
  const parts1 = v1.split('.').map(Number)
  const parts2 = v2.split('.').map(Number)
  
  for (let i = 0; i < 3; i++) {
    if (parts1[i] > parts2[i]) return 1
    if (parts1[i] < parts2[i]) return -1
  }
  
  return 0
}
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```typescript
/**
 * å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
 */
async function migrateIfNeeded(data: SaveData): Promise<SaveData> {
  const currentVersion = SAVE_DATA_VERSION
  const dataVersion = data.version
  
  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåŒã˜ãªã‚‰ä½•ã‚‚ã—ãªã„
  if (dataVersion === currentVersion) {
    return data
  }
  
  console.log(`Migrating save data from ${dataVersion} to ${currentVersion}`)
  
  let migratedData = data
  
  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã‚’é †æ¬¡å®Ÿè¡Œ
  const migrations = [
    { version: '1.0.0', migrate: migrate_1_0_0 },
    { version: '1.1.0', migrate: migrate_1_1_0 },
    // å°†æ¥ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç”¨
  ]
  
  for (const migration of migrations) {
    if (compareVersions(dataVersion, migration.version) < 0) {
      migratedData = await migration.migrate(migratedData)
      console.log(`Migrated to ${migration.version}`)
    }
  }
  
  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’æ›´æ–°
  migratedData.version = currentVersion
  
  return migratedData
}
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹

#### v1.0.0ï¼ˆåˆæœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰

```typescript
/**
 * v1.0.0ã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
 * åˆæœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã®ã§ä½•ã‚‚ã—ãªã„
 */
function migrate_1_0_0(data: any): SaveData {
  return data as SaveData
}
```

#### v1.1.0ï¼ˆçµ±è¨ˆæƒ…å ±è¿½åŠ ã‚’æƒ³å®šï¼‰

```typescript
/**
 * v1.1.0ã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
 * çµ±è¨ˆæƒ…å ±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
 */
function migrate_1_1_0(data: SaveData): SaveData {
  return {
    ...data,
    statistics: {
      totalDamageDealt: 0,
      totalDamageReceived: 0,
      totalMoneyEarned: data.player.money,
      totalExpEarned: data.player.exp,
      playTime: 0,
      firstPlayedAt: data.lastSaved
    }
  }
}
```

#### v1.2.0ï¼ˆæ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¿½åŠ ã‚’æƒ³å®šï¼‰

```typescript
/**
 * v1.2.0ã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
 * æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆä¾‹: LUCï¼‰ã‚’è¿½åŠ 
 */
function migrate_1_2_0(data: SaveData): SaveData {
  return {
    ...data,
    player: {
      ...data.player,
      stats: {
        ...data.player.stats,
        LUC: 5  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      },
      maxStats: {
        ...data.player.maxStats,
        maxLUC: 10  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      },
      levels: {
        ...data.player.levels,
        LUC: 1  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      }
    }
  }
}
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã¨å¯¾å¿œ

#### 1. ãƒ‡ãƒ¼ã‚¿ç ´æï¼ˆJSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ï¼‰

```typescript
function handleParseError(rawData: string): void {
  console.error('Save data is corrupted (JSON parse error)')
  
  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã‚‹
  const backupRestored = tryRestoreFromBackup()
  
  if (!backupRestored) {
    // ç ´æãƒ‡ãƒ¼ã‚¿ã‚’é€€é¿
    const timestamp = Date.now()
    localStorage.setItem(`hardboiled-corrupted-${timestamp}`, rawData)
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
    showErrorDialog({
      title: 'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã¾ã™',
      message: 'æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚',
      onConfirm: () => {
        localStorage.removeItem(STORAGE_KEYS.GAME_SAVE)
        location.reload()
      }
    })
  }
}
```

#### 2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼

```typescript
function handleValidationError(data: unknown): void {
  console.error('Save data validation failed', data)
  
  // ä¸€éƒ¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ¬ è½ã—ã¦ã„ã‚‹å ´åˆã¯è£œå®Œã‚’è©¦ã¿ã‚‹
  const repaired = tryRepairData(data)
  
  if (repaired && validateSaveData(repaired)) {
    console.log('Save data repaired successfully')
    applyLoadedData(repaired)
  } else {
    // ä¿®å¾©ä¸å¯èƒ½ãªå ´åˆã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
    tryRestoreFromBackup()
  }
}
```

#### 3. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸æ•´åˆ

```typescript
function handleVersionMismatch(dataVersion: string): void {
  const currentVersion = SAVE_DATA_VERSION
  
  // æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤ã„ã‚¢ãƒ—ãƒªã§é–‹ã“ã†ã¨ã—ãŸå ´åˆ
  if (compareVersions(dataVersion, currentVersion) > 0) {
    showErrorDialog({
      title: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼',
      message: `ã“ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¯æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ${dataVersion}ï¼‰ã§ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚\nç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${currentVersion}`,
      onConfirm: () => {
        // æ–°è¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹ã‹é¸æŠ
      }
    })
    return
  }
  
  // å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  console.log(`Migrating from ${dataVersion} to ${currentVersion}`)
}
```

#### 4. å®¹é‡è¶…é

```typescript
function handleQuotaExceeded(): void {
  console.error('localStorage quota exceeded')
  
  // å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤
  cleanupOldBackups()
  
  // å†è©¦è¡Œ
  try {
    saveGame()
    showNotification('ä¿å­˜ã—ã¾ã—ãŸ', 'success')
  } catch (error) {
    showErrorDialog({
      title: 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã‚¨ãƒ©ãƒ¼',
      message: 'ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚'
    })
  }
}
```

---

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ 

#### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ

```typescript
/**
 * ç¾åœ¨ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
 */
function backupExistingData(): void {
  try {
    const existing = localStorage.getItem(STORAGE_KEYS.GAME_SAVE)
    
    if (existing) {
      localStorage.setItem(STORAGE_KEYS.BACKUP, existing)
      console.log('Backup created')
    }
  } catch (error) {
    console.warn('Failed to create backup:', error)
  }
}
```

#### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©å…ƒ

```typescript
/**
 * ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
 */
function tryRestoreFromBackup(): boolean {
  try {
    const backup = localStorage.getItem(STORAGE_KEYS.BACKUP)
    
    if (!backup) {
      console.warn('No backup found')
      return false
    }
    
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼
    const parsedBackup = JSON.parse(backup)
    
    if (!validateSaveData(parsedBackup)) {
      console.error('Backup data is also invalid')
      return false
    }
    
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒ
    localStorage.setItem(STORAGE_KEYS.GAME_SAVE, backup)
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
    const migratedData = migrateIfNeeded(parsedBackup)
    applyLoadedData(migratedData)
    
    showNotification('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ', 'info')
    
    return true
    
  } catch (error) {
    console.error('Failed to restore from backup:', error)
    return false
  }
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚»ãƒ¼ãƒ–é »åº¦ã®åˆ¶é™

```typescript
/**
 * é€£ç¶šã—ãŸã‚»ãƒ¼ãƒ–è¦æ±‚ã‚’åˆ¶é™ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
 */
let saveTimeout: NodeJS.Timeout | null = null

function debouncedSave(): void {
  if (saveTimeout) {
    clearTimeout(saveTimeout)
  }
  
  saveTimeout = setTimeout(() => {
    saveGame()
    saveTimeout = null
  }, 1000)  // 1ç§’ã®é…å»¶
}
```

### ãƒ‡ãƒ¼ã‚¿åœ§ç¸®ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```typescript
/**
 * ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
 */
async function compressSaveData(data: SaveData): Promise<string> {
  const json = JSON.stringify(data)
  
  // pako ã‚„ lz-string ãªã©ã®åœ§ç¸®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
  // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºï¼ˆ~2KBï¼‰ã§ã¯ä¸è¦ã ãŒã€
  // å°†æ¥çš„ã«ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãããªã£ãŸå ´åˆã«å‚™ãˆã¦
  
  return json  // ç¾æ™‚ç‚¹ã§ã¯åœ§ç¸®ãªã—
}
```

### éåŒæœŸä¿å­˜

```typescript
/**
 * éåŒæœŸã§ã‚»ãƒ¼ãƒ–å‡¦ç†ã‚’å®Ÿè¡Œ
 */
async function asyncSaveGame(): Promise<boolean> {
  return new Promise((resolve) => {
    // æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã§å®Ÿè¡Œï¼ˆUIãƒ–ãƒ­ãƒƒã‚¯ã‚’é˜²ãï¼‰
    setTimeout(() => {
      const result = saveGame()
      resolve(result)
    }, 0)
  })
}
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®

### ãƒ‡ãƒ¼ã‚¿æ”¹ã–ã‚“å¯¾ç­–

#### ãƒã‚§ãƒƒã‚¯ã‚µãƒ æ¤œè¨¼

```typescript
/**
 * ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’è¨ˆç®—
 */
function calculateChecksum(data: SaveData): string {
  const json = JSON.stringify(data)
  
  // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒã‚·ãƒ¥è¨ˆç®—ï¼ˆæœ¬æ ¼çš„ã«ã¯crypto APIã‚’ä½¿ç”¨ï¼‰
  let hash = 0
  for (let i = 0; i < json.length; i++) {
    const char = json.charCodeAt(i)
    hash = ((hash << 5) - hash) + char
    hash = hash & hash  // 32bitæ•´æ•°ã«å¤‰æ›
  }
  
  return hash.toString(36)
}

/**
 * ãƒã‚§ãƒƒã‚¯ã‚µãƒ ä»˜ãã§ã‚»ãƒ¼ãƒ–
 */
function saveWithChecksum(data: SaveData): void {
  const checksum = calculateChecksum(data)
  
  const dataWithChecksum = {
    ...data,
    _checksum: checksum
  }
  
  localStorage.setItem(
    STORAGE_KEYS.GAME_SAVE,
    JSON.stringify(dataWithChecksum)
  )
}

/**
 * ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’æ¤œè¨¼
 */
function verifyChecksum(dataWithChecksum: any): boolean {
  const { _checksum, ...data } = dataWithChecksum
  
  if (!_checksum) {
    console.warn('No checksum found in save data')
    return true  // ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãŒãªã„å ´åˆã¯è¨±å®¹ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
  }
  
  const calculatedChecksum = calculateChecksum(data as SaveData)
  
  if (calculatedChecksum !== _checksum) {
    console.error('Checksum mismatch - data may be tampered')
    return false
  }
  
  return true
}
```

### XSSå¯¾ç­–

```typescript
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
 * ï¼ˆç¾åœ¨ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒãªã„ãŒã€å°†æ¥ã®æ‹¡å¼µã«å‚™ãˆã¦ï¼‰
 */
function sanitizeInput(input: string): string {
  return input
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;')
}
```

---

## å®Ÿè£…ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

```typescript
/**
 * localStorageã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹
 */
class GameStorage {
  /**
   * ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
   */
  static set(key: string, value: any): boolean {
    try {
      const serialized = JSON.stringify(value)
      localStorage.setItem(key, serialized)
      return true
    } catch (error) {
      console.error(`Failed to save ${key}:`, error)
      return false
    }
  }
  
  /**
   * ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
   */
  static get<T>(key: string, defaultValue: T): T {
    try {
      const item = localStorage.getItem(key)
      
      if (!item) {
        return defaultValue
      }
      
      return JSON.parse(item) as T
    } catch (error) {
      console.error(`Failed to load ${key}:`, error)
      return defaultValue
    }
  }
  
  /**
   * ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
   */
  static remove(key: string): void {
    try {
      localStorage.removeItem(key)
    } catch (error) {
      console.error(`Failed to remove ${key}:`, error)
    }
  }
  
  /**
   * ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
   */
  static clearAll(): void {
    Object.values(STORAGE_KEYS).forEach(key => {
      GameStorage.remove(key)
    })
  }
  
  /**
   * ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ä½¿ç”¨é‡ã‚’å–å¾—ï¼ˆãƒã‚¤ãƒˆï¼‰
   */
  static getUsage(): number {
    let total = 0
    
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i)
      if (key?.startsWith('hardboiled-')) {
        const value = localStorage.getItem(key) || ''
        total += key.length + value.length
      }
    }
    
    return total
  }
  
  /**
   * ä½¿ç”¨é‡ã‚’äººé–“ãŒèª­ã‚ã‚‹å½¢å¼ã§å–å¾—
   */
  static getUsageFormatted(): string {
    const bytes = GameStorage.getUsage()
    
    if (bytes < 1024) {
      return `${bytes}B`
    } else if (bytes < 1024 * 1024) {
      return `${(bytes / 1024).toFixed(2)}KB`
    } else {
      return `${(bytes / (1024 * 1024)).toFixed(2)}MB`
    }
  }
}
```

---

## ãƒ†ã‚¹ãƒˆæ–¹é‡

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```typescript
describe('GameStorage', () => {
  beforeEach(() => {
    localStorage.clear()
  })
  
  it('should save and load data correctly', () => {
    const testData = { test: 'value' }
    
    const saved = GameStorage.set('test-key', testData)
    expect(saved).toBe(true)
    
    const loaded = GameStorage.get('test-key', {})
    expect(loaded).toEqual(testData)
  })
  
  it('should return default value when key does not exist', () => {
    const defaultValue = { default: true }
    const result = GameStorage.get('nonexistent', defaultValue)
    
    expect(result).toEqual(defaultValue)
  })
  
  it('should handle corrupted data gracefully', () => {
    localStorage.setItem('test-key', 'invalid json{')
    
    const result = GameStorage.get('test-key', { default: true })
    expect(result).toEqual({ default: true })
  })
})

describe('SaveData validation', () => {
  it('should accept valid save data', () => {
    const validData: SaveData = {
      version: '1.0.0',
      lastSaved: new Date().toISOString(),
      saveId: 'test-id',
      player: {
        character: 'jack',
        stats: { HP: 100, SP: 50, AT: 10, DF: 5, AR: 1 },
        maxStats: { maxHP: 100, maxSP: 50, maxAT: 10, maxDF: 5, maxAR: 11 },
        levels: { HP: 1, SP: 1, AT: 1, DF: 1, AR: 1 },
        money: 0,
        exp: 0,
        ownedUnits: []
      },
      progress: {
        defeatedEnemies: [],
        totalBattles: 0,
        totalVictories: 0,
        totalDefeats: 0
      }
    }
    
    expect(validateSaveData(validData)).toBe(true)
  })
  
  it('should reject invalid save data', () => {
    const invalidData = {
      version: '1.0.0',
      // player ãŒæ¬ è½
      progress: {}
    }
    
    expect(validateSaveData(invalidData)).toBe(false)
  })
})
```

---

## ä½¿ç”¨ä¾‹

### ã‚²ãƒ¼ãƒ åˆæœŸåŒ–æ™‚

```typescript
// App.tsx ã¾ãŸã¯ main.tsx
async function initializeGame() {
  const gameStore = useGameStore.getState()
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
  gameStore.setLoading(true)
  
  try {
    // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
    const hasData = await loadGame()
    
    if (hasData) {
      console.log('Save data loaded')
      // ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã§ç”»é¢é·ç§»
      gameStore.navigateTo(Screen.ENEMY_SELECT)
    } else {
      console.log('No save data, starting new game')
      // æ–°è¦ã‚²ãƒ¼ãƒ 
      gameStore.navigateTo(Screen.TITLE)
    }
  } catch (error) {
    console.error('Failed to initialize game:', error)
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ–°è¦ã‚²ãƒ¼ãƒ 
    gameStore.navigateTo(Screen.TITLE)
  } finally {
    gameStore.setLoading(false)
  }
}
```

### æˆ¦é—˜çµ‚äº†æ™‚ã®è‡ªå‹•ã‚»ãƒ¼ãƒ–

```typescript
// BattleScreen.tsx
function handleBattleEnd(result: BattleResult) {
  const battleStore = useBattleStore()
  const playerStore = usePlayerStore()
  const gameStore = useGameStore()
  
  // å ±é…¬ã‚’ä»˜ä¸
  if (result.isVictory) {
    playerStore.addMoney(result.totalReward)
    playerStore.addExp(result.totalExp)
    
    // æ•µã‚’å€’ã—ãŸè¨˜éŒ²
    gameStore.recordVictory(battleStore.enemy.id)
  } else {
    gameStore.recordDefeat()
  }
  
  // è‡ªå‹•ã‚»ãƒ¼ãƒ–
  saveGame()
    .then(success => {
      if (success) {
        console.log('Auto-save completed')
      }
    })
    .catch(error => {
      console.error('Auto-save failed:', error)
    })
  
  // çµæœç”»é¢ã¸é·ç§»
  battleStore.setPhase(BattlePhase.RESULT)
}
```

### ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã®æ‰‹å‹•ã‚»ãƒ¼ãƒ–

```typescript
// MenuModal.tsx
function MenuModal() {
  const [isSaving, setIsSaving] = useState(false)
  
  const handleSave = async () => {
    setIsSaving(true)
    
    try {
      const success = await saveGame()
      
      if (success) {
        showNotification('ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success')
      } else {
        showNotification('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
      }
    } finally {
      setIsSaving(false)
    }
  }
  
  return (
    <Modal>
      <Button onClick={handleSave} disabled={isSaving}>
        {isSaving ? 'ä¿å­˜ä¸­...' : 'ã‚»ãƒ¼ãƒ–'}
      </Button>
    </Modal>
  )
}
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

#### å•é¡Œ1: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œãªã„

**åŸå› **:
- ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰
- localStorageãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹
- ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**:
```typescript
// localStorage ãŒä½¿ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
function isLocalStorageAvailable(): boolean {
  try {
    const test = '__localStorage_test__'
    localStorage.setItem(test, test)
    localStorage.removeItem(test)
    return true
  } catch (error) {
    return false
  }
}

// ä½¿ç”¨ä¸å¯ã®å ´åˆã¯è­¦å‘Š
if (!isLocalStorageAvailable()) {
  showErrorDialog({
    title: 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨ä¸å¯',
    message: 'ãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚\nãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã™ã‚‹ã‹ã€åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚'
  })
}
```

#### å•é¡Œ2: å®¹é‡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

**åŸå› **:
- ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ä¸Šé™ã«é”ã—ãŸ

**è§£æ±ºæ–¹æ³•**:
```typescript
// å®šæœŸçš„ã«å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤
function cleanupOldBackups(): void {
  const keys = Object.keys(localStorage)
  
  keys
    .filter(key => key.startsWith('hardboiled-corrupted-'))
    .forEach(key => {
      localStorage.removeItem(key)
      console.log(`Removed old corrupted data: ${key}`)
    })
}
```

---

**ä»¥ä¸Šã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆæ›¸ï¼ˆç¬¬1ç‰ˆï¼‰**
